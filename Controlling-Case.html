// ============================================
// PROJEKT-KOSTEN KI-REGEL ENGINE (ERWEITERT)
// ============================================
const projektKostenRegeln = {
    software: {
        titel: 'Software-Entwicklung',
        empfohleneBl√∂cke: [
            { id: 'personal', name: 'Personal', icon: 'üë•', anteil: 70 },
            { id: 'cloud', name: 'Cloud & Infrastructure', icon: '‚òÅÔ∏è', anteil: 15 },
            { id: 'lizenzen', name: 'Software-Lizenzen', icon: 'üíø', anteil: 10 },
            { id: 'testing', name: 'Testing & QA', icon: 'üß™', anteil: 5 }
        ],
        vorlaufzeit: 12,
        nachlaufzeit: 24
    },
    hardware: {
        titel: 'Hardware-Entwicklung',
        empfohleneBl√∂cke: [
            { id: 'personal', name: 'Personal', icon: 'üë•', anteil: 40 },
            { id: 'material', name: 'Material & Prototypen', icon: 'üîß', anteil: 30 },
            { id: 'werkzeuge', name: 'Werkzeuge & Formen', icon: '‚öôÔ∏è', anteil: 20 },
            { id: 'zertifizierung', name: 'Zertifizierung', icon: 'üìã', anteil: 10 }
        ],
        vorlaufzeit: 18,
        nachlaufzeit: 12
    },
    service: {
        titel: 'Service/Beratung',
        empfohleneBl√∂cke: [
            { id: 'personal', name: 'Personal', icon: 'üë•', anteil: 80 },
            { id: 'schulung', name: 'Schulungen', icon: 'üéì', anteil: 15 },
            { id: 'reise', name: 'Reisekosten', icon: '‚úàÔ∏è', anteil: 5 }
        ],
        vorlaufzeit: 3,
        nachlaufzeit: 36
    },
    hybrid: {
        titel: 'Hybrid-L√∂sung',
        empfohleneBl√∂cke: [
            { id: 'personal', name: 'Personal', icon: 'üë•', anteil: 50 },
            { id: 'hardware', name: 'Hardware-Komponenten', icon: 'üñ•Ô∏è', anteil: 20 },
            { id: 'software', name: 'Software-Lizenzen', icon: 'üíø', anteil: 15 },
            { id: 'beratung', name: 'Consulting & Setup', icon: 'üíº', anteil: 10 },
            { id: 'schulung', name: 'Schulung & Support', icon: 'üéì', anteil: 5 }
        ],
        vorlaufzeit: 12,
        nachlaufzeit: 24
    }
};

// Erweiterte Funktion: Intelligente Projekt-Typ Ermittlung
function ermittleProjektTyp() {
    const artikelData = cfoDashboard.artikelData[cfoDashboard.currentArtikel];
    if (!artikelData) return 'software'; // Default
    
    // Hole Werte aus den Dropdowns
    const kategorie = document.getElementById('produkt-kategorie')?.value || 'software';
    const geschaeftsmodell = document.getElementById('geschaeftsmodell')?.value || '';
    
    // Intelligente Erkennung von Hybrid-Modellen
    if (kategorie === 'hybrid') {
        return 'hybrid';
    }
    
    // Cyber Security, IoT, etc. sind oft Hybrid
    const hybridKeywords = ['cyber', 'security', 'iot', 'industrie 4.0', 'digital twin'];
    const artikelName = (artikelData.name || '').toLowerCase();
    
    if (hybridKeywords.some(keyword => artikelName.includes(keyword))) {
        return 'hybrid';
    }
    
    // Standard-Mapping
    return kategorie.toLowerCase();
}

// Erweiterte KI-Empfehlung mit Multi-Select
function generiereKostenEmpfehlung() {
    const projektTyp = ermittleProjektTyp();
    let regeln = projektKostenRegeln[projektTyp] || projektKostenRegeln.software;
    
    // Bei Hybrid: Kombiniere Bl√∂cke aus verschiedenen Bereichen
    if (projektTyp === 'hybrid') {
        const geschaeftsmodell = document.getElementById('geschaeftsmodell')?.value;
        
        // Passe Empfehlung basierend auf Gesch√§ftsmodell an
        if (geschaeftsmodell === 'subscription') {
            // Mehr Software-Fokus
            regeln.empfohleneBl√∂cke = [
                { id: 'personal', name: 'Personal (Dev & Support)', icon: 'üë•', anteil: 45 },
                { id: 'cloud', name: 'Cloud Infrastructure', icon: '‚òÅÔ∏è', anteil: 20 },
                { id: 'hardware', name: 'Hardware (Initial)', icon: 'üñ•Ô∏è', anteil: 15 },
                { id: 'beratung', name: 'Implementation Services', icon: 'üíº', anteil: 15 },
                { id: 'support', name: 'Ongoing Support', icon: 'üõ†Ô∏è', anteil: 5 }
            ];
        }
    }
    
    return {
        typ: projektTyp,
        regeln: regeln,
        zeitraum: {
            start: regeln.vorlaufzeit,
            ende: regeln.nachlaufzeit
        }
    };
}

function getProjekteTabContent() {
    // KI-Empfehlung generieren
    const empfehlung = generiereKostenEmpfehlung();
    const artikelData = cfoDashboard.artikelData[cfoDashboard.currentArtikel] || {};
    
    return `
        <div style="padding: 20px;">
            <!-- KI-Analyse Header -->
            <div style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">
                            ü§ñ KI-Projektkosten-Assistent
                        </h4>
                        <div style="font-size: 12px; color: var(--text);">
                            Erkannt: <strong>${empfehlung.regeln.titel}</strong> | 
                            Empfohlene Vorlaufzeit: <strong>${empfehlung.regeln.vorlaufzeit} Monate</strong> | 
                            Nachlaufzeit: <strong>${empfehlung.regeln.nachlaufzeit} Monate</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Projekt-Timeline -->
            <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border);">
                <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 12px;">‚è±Ô∏è Projekt-Timeline</h4>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div>
                        <label style="font-size: 10px; color: var(--gray); text-transform: uppercase;">Projektstart</label>
                        <input type="month" id="projekt-start" value="2024-01" 
                               onchange="updateProjektZeitraum()"
                               style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">
                    </div>
                    
                    <div>
                        <label style="font-size: 10px; color: var(--gray); text-transform: uppercase;">Release (aus Artikel)</label>
                        <div style="padding: 6px; background: var(--gray-light); border-radius: 4px; font-size: 12px; font-weight: 600;">
                            ${artikelData.release || '2025-01'}
                        </div>
                    </div>
                    
                    <div>
                        <label style="font-size: 10px; color: var(--gray); text-transform: uppercase;">Projektende</label>
                        <input type="month" id="projekt-ende" value="2027-12" 
                               onchange="updateProjektZeitraum()"
                               style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">
                    </div>
                </div>
            </div>

            <!-- Empfohlene Kostenbl√∂cke -->
            <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border);">
                <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 12px;">üìä Kostenbl√∂cke konfigurieren</h4>
                
                <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                    <div style="font-size: 11px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">
                        ‚ú® KI-Empfehlung f√ºr ${empfehlung.regeln.titel}:
                    </div>
                    <div id="empfohlene-kostenbl√∂cke" style="display: flex; flex-wrap: wrap; gap: 8px;">
    ${empfehlung.regeln.empfohleneBl√∂cke.map(block => `
        <div class="kostenblock-item" id="container-${block.id}" style="display: inline-flex; align-items: center; padding: 6px 10px; background: white; border: 1px solid var(--primary); border-radius: 4px; position: relative;">
            <input type="checkbox" checked id="block-${block.id}" 
                   onchange="updateKostenbloeckeAuswahl()"
                   data-block='${JSON.stringify(block)}' 
                   style="margin-right: 6px;">
            <label for="block-${block.id}" style="font-size: 11px; cursor: pointer; margin-right: 8px;">
                ${block.icon} ${block.name} (${block.anteil}%)
            </label>
            <button onclick="entferneKostenblock('${block.id}')" 
                    style="background: transparent; border: none; color: var(--danger); cursor: pointer; padding: 0 4px; font-size: 14px; line-height: 1;"
                    title="Kostenblock entfernen">
                √ó
            </button>
        </div>
    `).join('')}
</div>

                <button onclick="addCustomKostenblock()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                    + Eigenen Kostenblock hinzuf√ºgen
                </button>
            </div>

            <!-- Kostenplanung Tabelle -->
            <div id="projekt-kosten-tabelle">
                ${generateKostenTabelle()}
            </div>
        </div>
    `;
}

// Generiere Kostentabelle mit dynamischen Jahren und l√∂schbaren Zeilen
function generateKostenTabelle(customStartYear = null, customEndYear = null) {
    const empfehlung = generiereKostenEmpfehlung();
    
    // Jahre dynamisch bestimmen (wie vorher)
    let jahre = [];
    if (customStartYear && customEndYear) {
        for (let year = customStartYear; year <= customEndYear; year++) {
            jahre.push(year.toString());
        }
    } else {
        const startInput = document.getElementById('projekt-start');
        const endeInput = document.getElementById('projekt-ende');
        
        if (startInput && endeInput && startInput.value && endeInput.value) {
            const startYear = parseInt(startInput.value.split('-')[0]);
            const endYear = parseInt(endeInput.value.split('-')[0]);
            
            for (let year = startYear; year <= endYear; year++) {
                jahre.push(year.toString());
            }
        } else {
            jahre = ['2024', '2025', '2026', '2027', '2028'];
        }
    }
    
    // Nur aktive Bl√∂cke anzeigen
    const aktiveBl√∂cke = empfehlung.regeln.empfohleneBl√∂cke.filter(block => {
        const checkbox = document.getElementById(`block-${block.id}`);
        return !checkbox || checkbox.checked;
    });
    
    const artikelData = cfoDashboard.artikelData[cfoDashboard.currentArtikel] || {};
    const releaseYear = artikelData.release ? parseInt(artikelData.release.split('-')[0]) : null;
    
    return `
        <div style="background: white; border-radius: 8px; overflow-x: auto; border: 1px solid var(--border);">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                <thead>
                    <tr style="background: #f8fafc;">
                        <th style="padding: 8px; text-align: left;">Kostenblock</th>
                        ${jahre.map(jahr => {
                            const isReleaseYear = releaseYear && parseInt(jahr) === releaseYear;
                            return `<th style="padding: 8px; text-align: center; ${isReleaseYear ? 'background: #fef3c7;' : ''}">
                                ${jahr}
                                ${isReleaseYear ? '<br><span style="font-size: 9px; color: var(--warning);">Release</span>' : ''}
                            </th>`;
                        }).join('')}
                        <th style="padding: 8px; text-align: center; font-weight: bold;">Gesamt</th>
                        <th style="padding: 8px; text-align: center; width: 60px;">Aktion</th>
                    </tr>
                </thead>
                <tbody id="kosten-tbody">
                    ${aktiveBl√∂cke.map(block => `
                        <tr data-block-id="${block.id}" id="row-${block.id}">
                            <td style="padding: 8px; font-weight: 600;">
                                ${block.icon} ${block.name}
                                ${block.id === 'personal' ? `
                                    <button onclick="openPersonalDetail('${block.id}')"
                                            style="margin-left: 8px; padding: 2px 6px; background: var(--primary);
                                            color: white; border: none; border-radius: 3px; font-size: 9px; cursor: pointer;"
                                            title="Detailplanung √∂ffnen">
                                        üìä Details
                                    </button>
                                ` : ''}
                            </td>
                            ${jahre.map(jahr => {
                                const isReleaseYear = releaseYear && parseInt(jahr) === releaseYear;
                                return `<td style="padding: 8px; ${isReleaseYear ? 'background: #fffbeb;' : ''}">
                                    <input type="text" id="kosten-${block.id}-${jahr}" 
                                           placeholder="0"
                                           onchange="formatKostenInput(this); updateKostenSumme();"
                                           onblur="formatKostenInput(this);"
                                           style="width: 60px; padding: 2px; border: 1px solid var(--border); border-radius: 2px; text-align: right;">
                                </td>`;
                            }).join('')}
                            <td style="padding: 8px; font-weight: bold;" id="summe-${block.id}">0‚Ç¨</td>
                            <td style="padding: 8px; text-align: center;">
                                <button onclick="entferneTabellenzeile('${block.id}')" 
                                        style="background: transparent; border: 1px solid var(--danger); color: var(--danger); 
                                               padding: 2px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;"
                                        title="Zeile entfernen">
                                    ‚úï
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr style="background: var(--primary); color: white; font-weight: bold;">
                        <td style="padding: 10px;">GESAMT</td>
                        ${jahre.map(jahr => `<td style="padding: 10px; text-align: center;" id="gesamt-${jahr}">0‚Ç¨</td>`).join('')}
                        <td style="padding: 10px; text-align: center;" id="gesamt-total">0‚Ç¨</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
}

// Update Tabelle wenn Checkboxen ge√§ndert werden
function updateKostenbloeckeAuswahl() {
    // Tabelle neu generieren basierend auf aktiven Checkboxen
    updateProjektZeitraum();
}

// Update Kostensummen
function updateKostenSumme() {
    console.log('Updating Kostensummen...');
}

// Update Projekt-Zeitraum und synchronisiere Tabelle
function updateProjektZeitraum() {
    const startInput = document.getElementById('projekt-start');
    const endeInput = document.getElementById('projekt-ende');
    
    if (!startInput || !endeInput) return;
    
    const startDate = startInput.value; // Format: "2023-01"
    const endDate = endeInput.value;    // Format: "2027-12"
    
    if (!startDate || !endDate) return;
    
    // Parse Jahre aus den Datumswerten
    const startYear = parseInt(startDate.split('-')[0]);
    const endYear = parseInt(endDate.split('-')[0]);
    
    // Validierung
    if (endYear < startYear) {
        alert('Projektende kann nicht vor Projektstart liegen!');
        endeInput.value = startYear + '-12';
        return;
    }
    
    // Maximum 10 Jahre Projektlaufzeit
    if (endYear - startYear > 10) {
        alert('Maximale Projektlaufzeit ist 10 Jahre!');
        endeInput.value = (startYear + 10) + '-12';
        return;
    }
    
    // Tabelle neu generieren mit dynamischen Jahren
    const kostenTabelleContainer = document.getElementById('projekt-kosten-tabelle');
    if (kostenTabelleContainer) {
        kostenTabelleContainer.innerHTML = generateKostenTabelle(startYear, endYear);
    }
}

// Dynamisches Hinzuf√ºgen von Kostenbl√∂cken
function addCustomKostenblock() {
    const modalHTML = `
        <div id="kostenblock-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 24px; border-radius: 8px; max-width: 400px;">
                <h3 style="margin-bottom: 16px;">Kostenblock hinzuf√ºgen</h3>
                <input type="text" id="block-name" placeholder="Name des Kostenblocks" style="width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 4px;">
                
                <select id="block-type" style="width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 4px;">
                    <option value="">-- Kategorie w√§hlen --</option>
                    <option value="personal">Personal</option>
                    <option value="material">Material</option>
                    <option value="software">Software</option>
                    <option value="hardware">Hardware</option>
                    <option value="beratung">Beratung</option>
                    <option value="sonstige">Sonstige</option>
                </select>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeKostenblockModal()" style="padding: 8px 16px; border: 1px solid var(--border); background: white; border-radius: 4px;">Abbrechen</button>
                    <button onclick="saveKostenblock()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px;">Hinzuf√ºgen</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeKostenblockModal() {
    const modal = document.getElementById('kostenblock-modal');
    if (modal) modal.remove();
}

function saveKostenblock() {
    const name = document.getElementById('block-name').value;
    const type = document.getElementById('block-type').value;
    
    if (name && type) {
        // F√ºge neue Zeile zur Tabelle hinzu
        const tbody = document.getElementById('kosten-tbody');
        if (tbody) {
            const newRow = document.createElement('tr');
            const blockId = 'custom-' + Date.now();
            const jahre = ['2024', '2025', '2026', '2027', '2028'];
            
            newRow.innerHTML = `
                <td style="padding: 8px; font-weight: 600;">
                    ‚ûï ${name}
                </td>
                ${jahre.map(jahr => `
                    <td style="padding: 8px;">
                        <input type="text" placeholder="0" onchange="updateKostenSumme()"
                               style="width: 60px; padding: 2px; border: 1px solid var(--border); border-radius: 2px; text-align: right;">
                    </td>
                `).join('')}
                <td style="padding: 8px; font-weight: bold;">0‚Ç¨</td>
            `;
            
            tbody.appendChild(newRow);
        }
        
        closeKostenblockModal();
    }
}

// Setze initiale Timeline-Werte basierend auf Empfehlungen
function setzeInitialeTimeline() {
    const empfehlung = generiereKostenEmpfehlung();
    const artikelData = cfoDashboard.artikelData[cfoDashboard.currentArtikel] || {};
    
    // Parse Release-Datum
    const releaseDate = artikelData.release || '2025-01';
    const [releaseYear, releaseMonth] = releaseDate.split('-');
    
    // Berechne Start und Ende basierend auf Empfehlung
    const startYear = parseInt(releaseYear) - Math.floor(empfehlung.regeln.vorlaufzeit / 12);
    const endYear = parseInt(releaseYear) + Math.floor(empfehlung.regeln.nachlaufzeit / 12);
    
    // Setze die Werte in die Input-Felder
    const startInput = document.getElementById('projekt-start');
    const endeInput = document.getElementById('projekt-ende');
    
    if (startInput) startInput.value = `${startYear}-01`;
    if (endeInput) endeInput.value = `${endYear}-12`;
    
    // Trigger Update
    updateProjektZeitraum();
}

// Kostenblock komplett entfernen
function entferneKostenblock(blockId) {
    // Entferne den Container aus der DOM
    const container = document.getElementById(`container-${blockId}`);
    if (container) {
        container.remove();
    }
    
    // Update die Tabelle
    updateKostenbloeckeAuswahl();
}

// Kostenblock wieder hinzuf√ºgen
function kostenblockWiederHinzufuegen() {
    const modalHTML = `
        <div id="block-restore-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 24px; border-radius: 8px; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 16px;">Kostenblock ausw√§hlen</h3>
                <div style="font-size: 12px; color: var(--gray); margin-bottom: 16px;">
                    W√§hlen Sie einen Standard-Kostenblock oder erstellen Sie einen eigenen:
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 13px; margin-bottom: 12px;">Software-Bl√∂cke:</h4>
                    <button onclick="addStandardBlock('personal', 'Personal', 'üë•')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">üë• Personal</button>
                    <button onclick="addStandardBlock('cloud', 'Cloud & Infrastructure', '‚òÅÔ∏è')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">‚òÅÔ∏è Cloud & Infrastructure</button>
                    <button onclick="addStandardBlock('lizenzen', 'Software-Lizenzen', 'üíø')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">üíø Software-Lizenzen</button>
                    <button onclick="addStandardBlock('testing', 'Testing & QA', 'üß™')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">üß™ Testing & QA</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 13px; margin-bottom: 12px;">Hardware-Bl√∂cke:</h4>
                    <button onclick="addStandardBlock('material', 'Material & Prototypen', 'üîß')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">üîß Material & Prototypen</button>
                    <button onclick="addStandardBlock('werkzeuge', 'Werkzeuge & Formen', '‚öôÔ∏è')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">‚öôÔ∏è Werkzeuge & Formen</button>
                    <button onclick="addStandardBlock('zertifizierung', 'Zertifizierung', 'üìã')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">üìã Zertifizierung</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 13px; margin-bottom: 12px;">Service-Bl√∂cke:</h4>
                    <button onclick="addStandardBlock('beratung', 'Beratung', 'üíº')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">üíº Beratung</button>
                    <button onclick="addStandardBlock('schulung', 'Schulungen', 'üéì')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">üéì Schulungen</button>
                    <button onclick="addStandardBlock('reise', 'Reisekosten', '‚úàÔ∏è')" style="margin: 4px; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-size: 11px; cursor: pointer;">‚úàÔ∏è Reisekosten</button>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid var(--border); padding-top: 16px;">
                    <button onclick="closeBlockRestoreModal()" style="padding: 8px 16px; border: 1px solid var(--border); background: white; border-radius: 4px;">Schlie√üen</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function addStandardBlock(id, name, icon) {
    const container = document.getElementById('empfohlene-kostenbl√∂cke');
    
    // Pr√ºfe ob Block schon existiert
    if (document.getElementById(`container-${id}`)) {
        alert('Dieser Kostenblock ist bereits vorhanden!');
        return;
    }
    
    // F√ºge neuen Block hinzu
    const newBlock = document.createElement('div');
    newBlock.className = 'kostenblock-item';
    newBlock.id = `container-${id}`;
    newBlock.style = 'display: inline-flex; align-items: center; padding: 6px 10px; background: white; border: 1px solid var(--primary); border-radius: 4px; position: relative;';
    
    newBlock.innerHTML = `
        <input type="checkbox" checked id="block-${id}" 
               onchange="updateKostenbloeckeAuswahl()"
               data-block='{"id":"${id}","name":"${name}","icon":"${icon}","anteil":0}' 
               style="margin-right: 6px;">
        <label for="block-${id}" style="font-size: 11px; cursor: pointer; margin-right: 8px;">
            ${icon} ${name}
        </label>
        <button onclick="entferneKostenblock('${id}')" 
                style="background: transparent; border: none; color: var(--danger); cursor: pointer; padding: 0 4px; font-size: 14px; line-height: 1;"
                title="Kostenblock entfernen">
            √ó
        </button>
    `;
    
    container.appendChild(newBlock);
    closeBlockRestoreModal();
    updateKostenbloeckeAuswahl();
}

function closeBlockRestoreModal() {
    const modal = document.getElementById('block-restore-modal');
    if (modal) modal.remove();
}

// Entferne Tabellenzeile und deaktiviere entsprechende Checkbox
function entferneTabellenzeile(blockId) {
    // Entferne die Zeile aus der Tabelle
    const row = document.getElementById(`row-${blockId}`);
    if (row) {
        row.remove();
    }
    
    // Deaktiviere die entsprechende Checkbox oben
    const checkbox = document.getElementById(`block-${blockId}`);
    if (checkbox) {
        checkbox.checked = false;
    }
      // Update Summen
    updateKostenSumme();
}

// Update Kostensummen - Berechnet alle Summen automatisch
function updateKostenSumme() {
    const tbody = document.getElementById('kosten-tbody');
    if (!tbody) return;
    
    // Sammle alle Jahre aus den Tabellen-Headers
    const headerCells = document.querySelectorAll('thead th');
    const jahre = [];
    headerCells.forEach(cell => {
        const cellText = cell.textContent.trim();
        // Extrahiere Jahr (4-stellige Zahl)
        if (/^\d{4}/.test(cellText)) {
            jahre.push(cellText.substring(0, 4));
        }
    });
    
    // Initialisiere Jahres-Summen
    const jahresSummen = {};
    jahre.forEach(jahr => {
        jahresSummen[jahr] = 0;
    });
    
    let gesamtSummeAlle = 0;
    
    // Durchlaufe alle Zeilen
    const rows = tbody.querySelectorAll('tr[data-block-id]');
    rows.forEach(row => {
        const blockId = row.dataset.blockId;
        let zeilenSumme = 0;
        
        // Durchlaufe alle Jahre f√ºr diese Zeile
        jahre.forEach(jahr => {
            const input = document.getElementById(`kosten-${blockId}-${jahr}`);
            if (input) {
                // Parse den Wert (entferne Tausender-Trenner, ersetze Komma mit Punkt)
                let value = input.value.trim();
                value = value.replace(/\./g, '').replace(',', '.');
                const numValue = parseFloat(value) || 0;
                
                // Addiere zur Zeilensumme und Jahressumme
                zeilenSumme += numValue;
                jahresSummen[jahr] += numValue;
            }
        });
        
        // Update Zeilensumme
        const summeCell = document.getElementById(`summe-${blockId}`);
        if (summeCell) {
            summeCell.textContent = formatKostenAnzeige(zeilenSumme);
        }
        
        gesamtSummeAlle += zeilenSumme;
    });
    
    // Update Jahres-Summen in der Fu√üzeile
    jahre.forEach(jahr => {
        const gesamtCell = document.getElementById(`gesamt-${jahr}`);
        if (gesamtCell) {
            gesamtCell.textContent = formatKostenAnzeige(jahresSummen[jahr]);
        }
    });
    
    // Update Gesamt-Summe
    const gesamtTotalCell = document.getElementById('gesamt-total');
    if (gesamtTotalCell) {
        gesamtTotalCell.textContent = formatKostenAnzeige(gesamtSummeAlle);
    }
}

// Formatiere Kostenanzeige (mit k‚Ç¨ oder M‚Ç¨)
function formatKostenAnzeige(value) {
    if (value === 0) return '0‚Ç¨';
    
    // Wenn >= 1 Million
    if (value >= 1000) {
        return (value / 1000).toFixed(1).replace('.', ',') + 'M‚Ç¨';
    }
    
    // Standard in k‚Ç¨
    return value.toFixed(0) + '‚Ç¨';
}

// Erweiterte Input-Formatierung mit automatischer Berechnung
function formatKostenInput(input) {
    let value = input.value.trim();
    
    // Erlaube leeres Feld
    if (value === '') {
        updateKostenSumme();
        return;
    }
    
    // Entferne alle Nicht-Zahlen au√üer Komma und Punkt
    value = value.replace(/[^\d,.-]/g, '');
    
    // Ersetze Komma mit Punkt f√ºr Berechnung
    value = value.replace(',', '.');
    
    const numValue = parseFloat(value);
    
    if (!isNaN(numValue)) {
        // Formatiere ohne Nachkommastellen f√ºr Kosten
        input.value = Math.round(numValue).toString();
    }
    
    // Trigger Berechnung
    updateKostenSumme();
}

// √ñffne Personal-Detailplanung Sidebar
function openPersonalDetail(blockId) {
    // Hole vorhandene Daten falls vorhanden
    const kostenDaten = getPersonalKostenDaten(blockId);
    
    const sidebarHTML = `
        <div id="personal-detail-sidebar" style="position: fixed; top: 0; right: -50%; bottom: 0; 
             width: 50%; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); 
             z-index: 9998; transition: right 0.3s ease-in-out; overflow-y: auto;">
            
            <!-- Header -->
            <div style="padding: 20px; background: linear-gradient(135deg, #dbeafe, #e0e7ff); 
                        border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 16px; color: var(--primary);">
                        üë• Personalkosten - Detailplanung
                    </h3>
                    <button onclick="closePersonalDetail()" 
                            style="background: transparent; border: none; font-size: 20px; 
                                   cursor: pointer; color: var(--gray);">‚úï</button>
                </div>
            </div>
            
            <!-- KI-Hinweise -->
            <div id="ki-hints" style="padding: 16px; background: #fef3c7; border-left: 4px solid var(--warning); margin: 16px;">
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">
                    ü§ñ KI-Analyse:
                </div>
                <div id="ki-feedback" style="font-size: 11px; line-height: 1.5;">
                    Analysiere Teamzusammensetzung...
                </div>
            </div>
            
            <!-- Positions-Tabelle -->
            <div style="padding: 20px;">
                <h4 style="font-size: 14px; margin-bottom: 16px;">Team-Zusammensetzung</h4>
                
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid var(--border);">
                            <th style="padding: 10px; text-align: left;">Position</th>
                            <th style="padding: 10px; text-align: center;">Anzahl</th>
                            <th style="padding: 10px; text-align: center;">Gehalt/Jahr</th>
                            <th style="padding: 10px; text-align: center;">2024</th>
                            <th style="padding: 10px; text-align: center;">2025</th>
                            <th style="padding: 10px; text-align: center;">2026</th>
                            <th style="padding: 10px; text-align: center;">2027</th>
                            <th style="padding: 10px; text-align: center;">Gesamt</th>
                            <th style="padding: 10px; text-align: center;">Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="personal-detail-tbody">
                        ${generatePersonalPositions()}
                    </tbody>
                    <tfoot>
                        <tr style="background: var(--primary); color: white; font-weight: bold;">
                            <td style="padding: 10px;" colspan="3">SUMME</td>
                            <td style="padding: 10px; text-align: center;" id="personal-sum-2024">0‚Ç¨</td>
                            <td style="padding: 10px; text-align: center;" id="personal-sum-2025">0‚Ç¨</td>
                            <td style="padding: 10px; text-align: center;" id="personal-sum-2026">0‚Ç¨</td>
                            <td style="padding: 10px; text-align: center;" id="personal-sum-2027">0‚Ç¨</td>
                            <td style="padding: 10px; text-align: center;" id="personal-sum-total">0‚Ç¨</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                
                <button onclick="addPersonalPosition()" 
                        style="margin-top: 16px; padding: 8px 16px; background: var(--primary); 
                               color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                    + Position hinzuf√ºgen
                </button>
                
                <!-- Vorlagen -->
                <div style="margin-top: 20px; padding: 16px; background: #f0f9ff; border-radius: 8px;">
                    <h5 style="font-size: 13px; margin-bottom: 12px;">üéØ Schnell-Vorlagen</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="applyPersonalTemplate('scrum-team')" 
                                style="padding: 6px 12px; background: white; border: 1px solid var(--primary); 
                                       color: var(--primary); border-radius: 4px; font-size: 11px; cursor: pointer;">
                            Scrum Team (8 Personen)
                        </button>
                        <button onclick="applyPersonalTemplate('startup')" 
                                style="padding: 6px 12px; background: white; border: 1px solid var(--primary); 
                                       color: var(--primary); border-radius: 4px; font-size: 11px; cursor: pointer;">
                            Startup Team (3 Personen)
                        </button>
                        <button onclick="applyPersonalTemplate('enterprise')" 
                                style="padding: 6px 12px; background: white; border: 1px solid var(--primary); 
                                       color: var(--primary); border-radius: 4px; font-size: 11px; cursor: pointer;">
                            Enterprise Team (15 Personen)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Footer mit Aktionen -->
            <div style="position: sticky; bottom: 0; padding: 20px; background: white; 
                        border-top: 1px solid var(--border); display: flex; justify-content: space-between;">
                <button onclick="closePersonalDetail()" 
                        style="padding: 10px 20px; border: 1px solid var(--border); 
                               background: white; border-radius: 4px; cursor: pointer;">
                    Abbrechen
                </button>
                <button onclick="savePersonalDetail()" 
                        style="padding: 10px 20px; background: var(--primary); color: white; 
                               border: none; border-radius: 4px; cursor: pointer;">
                    √úbernehmen & Schlie√üen
                </button>
            </div>
        </div>
    `;
    
    // F√ºge Sidebar zum DOM hinzu
    document.body.insertAdjacentHTML('beforeend', sidebarHTML);
    
    // Slide-in Animation
    setTimeout(() => {
        document.getElementById('personal-detail-sidebar').style.right = '0';
    }, 10);
    
    // Initial-Berechnung
    calculatePersonalSums();
    checkPersonalPlausibility();
}

// Generiere Standard-Positionen
function generatePersonalPositions() {
    const positions = [
        { id: 'senior-dev', name: 'Senior Developer', anzahl: 3, gehalt: 120000 },
        { id: 'junior-dev', name: 'Junior Developer', anzahl: 2, gehalt: 70000 },
        { id: 'pm', name: 'Projektleiter', anzahl: 1, gehalt: 130000 },
        { id: 'qa', name: 'QA Engineer', anzahl: 2, gehalt: 85000 }
    ];
    
    return positions.map(pos => `
        <tr data-position-id="${pos.id}">
            <td style="padding: 8px;">
                <input type="text" value="${pos.name}" 
                       style="width: 100%; padding: 4px; border: 1px solid var(--border); 
                              border-radius: 3px; font-size: 11px;">
            </td>
            <td style="padding: 8px; text-align: center;">
                <input type="number" value="${pos.anzahl}" min="0" step="0.5"
                       onchange="calculatePersonalSums(); checkPersonalPlausibility();"
                       style="width: 60px; padding: 4px; border: 1px solid var(--border); 
                              border-radius: 3px; text-align: center;">
            </td>
            <td style="padding: 8px;">
                <input type="number" value="${pos.gehalt}" step="1000"
                       onchange="calculatePersonalSums(); checkPersonalPlausibility();"
                       style="width: 80px; padding: 4px; border: 1px solid var(--border); 
                              border-radius: 3px; text-align: right;">‚Ç¨
            </td>
            ${['2024', '2025', '2026', '2027'].map(jahr => `
                <td style="padding: 8px;">
                    <input type="number" min="0" max="${pos.anzahl}" step="0.5"
                           placeholder="${pos.anzahl}"
                           onchange="calculatePersonalSums();"
                           style="width: 50px; padding: 4px; border: 1px solid var(--border); 
                                  border-radius: 3px; text-align: center;">
                </td>
            `).join('')}
            <td style="padding: 8px; text-align: right; font-weight: bold;" 
                id="pos-sum-${pos.id}">0‚Ç¨</td>
            <td style="padding: 8px; text-align: center;">
                <button onclick="removePersonalPosition('${pos.id}')"
                        style="background: transparent; border: 1px solid var(--danger); 
                               color: var(--danger); padding: 2px 6px; border-radius: 3px; 
                               font-size: 10px; cursor: pointer;">‚úï</button>
            </td>
        </tr>
    `).join('');
}

// Berechne Personal-Summen
function calculatePersonalSums() {
    const tbody = document.getElementById('personal-detail-tbody');
    if (!tbody) return;
    
    const jahre = ['2024', '2025', '2026', '2027'];
    const jahresSummen = {};
    jahre.forEach(jahr => jahresSummen[jahr] = 0);
    
    let gesamtSumme = 0;
    
    // Durchlaufe alle Positionen
    tbody.querySelectorAll('tr').forEach(row => {
        const inputs = row.querySelectorAll('input[type="number"]');
        const anzahl = parseFloat(inputs[0].value) || 0;
        const gehalt = parseFloat(inputs[1].value) || 0;
        
        let positionsSumme = 0;
        
        // Berechne f√ºr jedes Jahr
        jahre.forEach((jahr, index) => {
            const fte = parseFloat(inputs[index + 2].value) || anzahl;
            const jahresKosten = fte * gehalt;
            jahresSummen[jahr] += jahresKosten;
            positionsSumme += jahresKosten;
        });
        
        // Update Positionssumme
        const sumCell = row.querySelector('[id^="pos-sum-"]');
        if (sumCell) {
            sumCell.textContent = formatKostenAnzeige(positionsSumme / 1000) + '‚Ç¨';
        }
        
        gesamtSumme += positionsSumme;
    });
    
    // Update Footer-Summen
    jahre.forEach(jahr => {
        const cell = document.getElementById(`personal-sum-${jahr}`);
        if (cell) {
            cell.textContent = formatKostenAnzeige(jahresSummen[jahr] / 1000) + '‚Ç¨';
        }
    });
    
    const totalCell = document.getElementById('personal-sum-total');
    if (totalCell) {
        totalCell.textContent = formatKostenAnzeige(gesamtSumme / 1000) + '‚Ç¨';
    }
}

// KI-Plausibilit√§tspr√ºfung
function checkPersonalPlausibility() {
    const feedback = document.getElementById('ki-feedback');
    if (!feedback) return;
    
    const warnings = [];
    const tbody = document.getElementById('personal-detail-tbody');
    
    // Pr√ºfe Geh√§lter
    tbody.querySelectorAll('tr').forEach(row => {
        const nameInput = row.querySelector('input[type="text"]');
        const gehaltInput = row.querySelectorAll('input[type="number"]')[1];
        
        const position = nameInput.value.toLowerCase();
        const gehalt = parseFloat(gehaltInput.value);
        
        // Plausibilit√§tspr√ºfungen
        if (position.includes('praktikant') && gehalt > 30000) {
            warnings.push(`‚ö†Ô∏è Praktikanten-Gehalt (${gehalt}‚Ç¨) ungew√∂hnlich hoch`);
        }
        if (position.includes('senior') && gehalt < 80000) {
            warnings.push(`‚ö†Ô∏è Senior-Position unter Marktdurchschnitt`);
        }
        if (position.includes('junior') && gehalt > 100000) {
            warnings.push(`‚ö†Ô∏è Junior-Gehalt √ºber Marktdurchschnitt`);
        }
    });
    
    // Team-Zusammensetzung pr√ºfen
    const devCount = [...tbody.querySelectorAll('input[type="text"]')]
        .filter(i => i.value.toLowerCase().includes('developer')).length;
    const qaCount = [...tbody.querySelectorAll('input[type="text"]')]
        .filter(i => i.value.toLowerCase().includes('qa') || i.value.toLowerCase().includes('test')).length;
    
    if (devCount > 3 && qaCount === 0) {
        warnings.push(`üí° Empfehlung: QA-Ressourcen f√ºr ${devCount} Entwickler fehlen`);
    }
    
    // Update KI-Feedback
    if (warnings.length > 0) {
        feedback.innerHTML = warnings.join('<br>');
        feedback.parentElement.style.background = '#fef3c7';
    } else {
        feedback.innerHTML = '‚úÖ Teamzusammensetzung sieht plausibel aus';
        feedback.parentElement.style.background = '#d1fae5';
    }
}

// Schlie√üe Personal-Detail Sidebar
function closePersonalDetail() {
    const sidebar = document.getElementById('personal-detail-sidebar');
    if (sidebar) {
        sidebar.style.right = '-50%';
        setTimeout(() => sidebar.remove(), 300);
    }
}

// Speichere und √ºbernehme Werte
function savePersonalDetail() {
    // √úbertrage Summen in Haupttabelle
    const jahre = ['2024', '2025', '2026', '2027'];
    jahre.forEach(jahr => {
        const sumValue = document.getElementById(`personal-sum-${jahr}`);
        const mainInput = document.getElementById(`kosten-personal-${jahr}`);
        if (sumValue && mainInput) {
            // Konvertiere von ‚Ç¨ zu Eingabeformat
            const value = sumValue.textContent.replace('‚Ç¨', '').replace('k', '');
            mainInput.value = value;
        }
    });
    
    // Update Haupttabelle
    updateKostenSumme();
    
    // Schlie√üe Sidebar
    closePersonalDetail();
}

// Weitere Hilfsfunktionen
function getPersonalKostenDaten(blockId) {
    // Hole gespeicherte Daten falls vorhanden
    return cfoDashboard.personalDetails || {};
}

function addPersonalPosition() {
    // Implementierung folgt
    alert('Position hinzuf√ºgen - wird implementiert');
}

function removePersonalPosition(posId) {
    const row = document.querySelector(`[data-position-id="${posId}"]`);
    if (row) {
        row.remove();
        calculatePersonalSums();
        checkPersonalPlausibility();
    }
}

function applyPersonalTemplate(template) {
    // Implementierung folgt
    alert(`Template "${template}" wird geladen...`);
}

// ============================================
// PERSONAL DETAIL-PLANUNG FUNKTIONEN
// ============================================

// √ñffne Personal-Detailplanung Sidebar
function openPersonalDetail(blockId) {
    // [Hier kommt der lange Code aus meiner vorherigen Nachricht]
}

// Generiere Standard-Positionen
function generatePersonalPositions() {
    // [Hier kommt der Code]
}

// Berechne Personal-Summen
function calculatePersonalSums() {
    // [Hier kommt der Code]
}

// ... und alle anderen Funktionen
