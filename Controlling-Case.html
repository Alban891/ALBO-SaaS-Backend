<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFO Dashboard - Business Case WCAR Schaltschrankkomponenten</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray: #6b7280;
            --gray-light: #f8fafc;
            --border: #e5e7eb;
            --text: #1f2937;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gray-light);
            color: var(--text);
        }

        .dashboard {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 16px 24px;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 20px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .header-stats {
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .dashboard-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Enhanced Sidebar f√ºr KI-Assistent */
        .sidebar {
            width: 400px;
            background: var(--white);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* KI-Status Header */
        .ai-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .ai-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-status-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* KI Metrics Panel */
        .ai-metrics-panel {
            background: var(--white);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .ai-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 12px;
        }
        
        .ai-metric-label {
            color: var(--gray);
            font-weight: 500;
        }
        
        .ai-metric-value {
            font-weight: 600;
            color: var(--text);
        }
        
        .ai-metric-value.good {
            color: var(--success);
        }
        
        .ai-metric-value.warning {
            color: var(--warning);
        }
        
        .ai-metric-value.critical {
            color: var(--danger);
        }

        /* Tab Navigation */
        .tab-navigation {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            display: flex;
            padding: 0 24px;
        }

        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: none;
            color: var(--gray);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary);
            background: var(--gray-light);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--gray-light);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Dashboard Tab Styles */
        .quick-controls {
            background: var(--white);
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 24px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 150px;
        }

        .control-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
        }

        .control-slider {
            appearance: none;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
        }

        .control-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .control-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
        }

        .artikel-toggle {
            display: flex;
            gap: 8px;
        }

        .artikel-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--white);
            color: var(--gray);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .artikel-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Charts Area */
        .charts-area {
            flex: 1;
            padding: 24px;
            overflow: auto;
        }

        .charts-grid-three {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            height: 100%;
        }

        /* Dashboard Grid - Original Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            height: calc(100vh - 200px);
            padding: 24px;
        }

        /* New Dashboard Layout - 6 Charts wie Excel */
        .dashboard-main {
            padding: 24px;
            overflow-y: auto;
            height: calc(100vh - 150px);
        }

        .charts-row-top,
        .charts-row-middle,
        .charts-row-bottom {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .charts-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .kpi-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .chart-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .chart-info {
            font-size: 11px;
            color: var(--gray);
            background: var(--gray-light);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .chart-container {
            position: relative;
            height: 220px;
            flex: 1;
        }

        /* Special Containers */
        .chart-container-special {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kumuliert-display {
            text-align: center;
            background: var(--gray-light);
            padding: 40px;
            border-radius: 8px;
            border: 2px solid var(--primary);
        }

        .kumuliert-value {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .kumuliert-label {
            font-size: 14px;
            color: var(--gray);
            font-weight: 600;
        }

        /* Projekte Mini Table */
        .projekte-panel {
            min-height: 300px;
        }

        .projekte-mini-table {
            flex: 1;
            font-size: 11px;
        }

        .projekt-row {
            display: grid;
            grid-template-columns: auto auto;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .projekt-row:last-child {
            border-bottom: none;
        }

        .projekt-col {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .projekt-label {
            font-weight: 600;
            color: var(--gray);
            padding: 4px 0;
        }

        .projekt-name {
            font-weight: 600;
            color: var(--text);
            font-size: 10px;
        }

        .projekt-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .projekt-value {
            padding: 4px 0;
            color: var(--text);
        }

        .projekt-value div {
            margin-bottom: 2px;
        }

        /* Amortisation Display */
        .amortisation-display {
            text-align: center;
            background: var(--gray-light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .amortisation-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 4px;
        }

        .amortisation-label {
            font-size: 12px;
            color: var(--gray);
            font-weight: 600;
        }

        /* Szenarien Box */
        .szenarien-box {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
        }

        .szenarien-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .szenarien-grid {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .szenario-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            font-size: 10px;
            padding: 2px 0;
        }

        .szenario-row span:first-child {
            color: var(--gray);
        }

        .szenario-row span:last-child {
            color: var(--text);
            font-weight: 600;
            background: var(--gray-light);
            padding: 2px 6px;
            border-radius: 3px;
            text-align: center;
        }

        /* Assumptions Tab Content - Simplified */
        .assumptions-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .assumptions-section {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
        }

        /* Analysis Tab */
        .analysis-container {
            padding: 40px;
            text-align: center;
            color: var(--gray);
        }
        
        /* Artikel Cards Styles */
        .artikel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .artikel-card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .artikel-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
            transform: translateY(-2px);
        }

        .artikel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .artikel-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .artikel-effect {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .neu-produkt {
            background: #dbeafe;
            color: var(--primary);
        }

        .cross-selling {
            background: #dcfce7;
            color: var(--success);
        }

        .artikel-details {
            margin-bottom: 16px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
        }

        .detail-label {
            color: var(--gray);
            font-weight: 500;
        }

        .detail-value {
            color: var(--text);
            font-weight: 600;
        }

        .detail-value.success {
            color: var(--success);
        }

        .artikel-assumptions {
            background: var(--gray-light);
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--gray);
            border-left: 3px solid var(--primary);
        }

        .add-artikel-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-artikel-btn:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }
        
        /* Artikel Detail View */
        .artikel-detail-view {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--primary);
        }

        .detail-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .back-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--white);
            color: var(--gray);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Sub-Tab Navigation */
        .sub-tab-navigation {
            background: var(--gray-light);
            border-radius: 8px;
            padding: 4px;
            display: flex;
            margin-bottom: 24px;
        }

        .sub-tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: none;
            color: var(--gray);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .sub-tab-btn:hover {
            color: var(--primary);
        }

        .sub-tab-btn.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Sidebar - KI Assistant Enhanced*/
        .ai-feed {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(to bottom, #f8fafc, #ffffff);
        }

        .ai-feed-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-message {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .ai-message.success {
            border-left-color: var(--success);
            background: #f0fdf4;
        }

        .ai-message.warning {
            border-left-color: var(--warning);
            background: #fffbeb;
        }

        .ai-message.critical {
            border-left-color: var(--danger);
            background: #fef2f2;
        }

        .message-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text);
        }

        .message-text {
            font-size: 12px;
            line-height: 1.5;
            color: var(--gray);
        }

        .message-text strong {
            color: var(--text);
        }

        .message-actions {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .message-actions ul {
            margin: 4px 0 0 16px;
            font-size: 11px;
        }

        .message-timestamp {
            font-size: 10px;
            color: var(--gray);
            margin-top: 6px;
            opacity: 0.8;
        }

        .ai-actions {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--gray-light);
        }

        .ai-action-btn {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            background: var(--white);
            color: var(--gray);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--gray-light);
            transform: translateX(4px);
        }

        .ai-action-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .sidebar {
                width: 350px;
            }
        }

        @media (max-width: 1200px) {
            .charts-grid-three {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <div class="title">Business Case: WCAR Schaltschrankkomponenten</div>
                    <div class="subtitle">KI-gest√ºtzte Echtzeit-Analyse mit intelligenten Handlungsempfehlungen</div>
                </div>
                <div class="header-stats">
                    <div class="stat">
                        <div class="stat-value" id="npv-value">+44,7M‚Ç¨</div>
                        <div class="stat-label">NPV (9 Jahre)</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="payback-value">3,4J</div>
                        <div class="stat-label">Payback</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="revenue-value">117,8M‚Ç¨</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="margin-value">34%</div>
                        <div class="stat-label">√ò DB2-Marge</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            
            <!-- Dashboard Content -->
            <div class="dashboard-content">
                
                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn active" onclick="switchTab('dashboard')">
                        üìä Dashboard
                    </button>
                    <button class="tab-btn" onclick="switchTab('assumptions')">
                        ‚öôÔ∏è Annahmen bearbeiten
                    </button>
                    <button class="tab-btn" onclick="switchTab('analysis')">
                        üìà Analyse
                    </button>
                    <button class="tab-btn" onclick="switchTab('ai-agents')">
                        ü§ñ KI Agenten
                    </button>
                </div>
                
                <!-- Tab Content: Dashboard -->
                <div class="tab-content active" id="tab-dashboard">
                    <!-- Quick Controls -->
                    <div class="quick-controls">
                        <div class="control-section">
                            <span class="control-label">Marktvolumen</span>
                            <input type="range" class="control-slider" id="market-volume" 
                                   min="50" max="150" value="100" 
                                   onchange="adjustAssumption('market', this.value)">
                            <span class="control-value" id="market-value">100%</span>
                        </div>
                        
                        <div class="control-section">
                            <span class="control-label">Preis-Premium</span>
                            <input type="range" class="control-slider" id="price-premium" 
                                   min="80" max="120" value="100" 
                                   onchange="adjustAssumption('price', this.value)">
                            <span class="control-value" id="price-value">+0%</span>
                        </div>
                        
                        <div class="control-section">
                            <span class="control-label">CAPEX-Risiko</span>
                            <input type="range" class="control-slider" id="capex-risk" 
                                   min="80" max="130" value="100" 
                                   onchange="adjustAssumption('capex', this.value)">
                            <span class="control-value" id="capex-value">Plan</span>
                        </div>
                        
                        <div class="artikel-toggle">
                            <button class="artikel-btn active" onclick="toggleArtikel('all')">Alle</button>
                            <button class="artikel-btn" onclick="toggleArtikel('crimp')">Crimp</button>
                            <button class="artikel-btn" onclick="toggleArtikel('komax')">Komax</button>
                            <button class="artikel-btn" onclick="toggleArtikel('digital')">Digital</button>
                        </div>
                    </div>
                    
                    <!-- Main Dashboard - 6 Charts Layout wie Excel -->
                    <div class="dashboard-main">
                        
                        <!-- Top Row: 3 Charts -->
                        <div class="charts-row-top">
                            <!-- Umsatz Chart -->
                            <div class="chart-panel">
                                <div class="chart-header">
                                    <div class="chart-title">Umsatz</div>
                                    <div class="chart-info">in Mio. ‚Ç¨</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="umsatz-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Absatz Chart -->
                            <div class="chart-panel">
                                <div class="chart-header">
                                    <div class="chart-title">Absatz</div>
                                    <div class="chart-info">in T St√ºck</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="absatz-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- DB2 Chart -->
                            <div class="chart-panel">
                                <div class="chart-header">
                                    <div class="chart-title">DB 2*</div>
                                    <div class="chart-info">in Mio. ‚Ç¨ ‚Ä¢ *nach variablen Kosten</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="db2-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Middle Row: Projektkosten -->
                        <div class="charts-row-middle">
                            <!-- Projektkosten Jahres-Chart -->
                            <div class="chart-panel">
                                <div class="chart-header">
                                    <div class="chart-title">Projektkosten</div>
                                    <div class="chart-info">in Mio. ‚Ç¨</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="projektkosten-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Projektkosten Kumuliert -->
                            <div class="chart-panel">
                                <div class="chart-header">
                                    <div class="chart-title">Projektkosten</div>
                                    <div class="chart-info">in Mio. ‚Ç¨</div>
                                </div>
                                <div class="chart-container-special">
                                    <div class="kumuliert-display">
                                        <div class="kumuliert-value" id="kumuliert-value">18,8</div>
                                        <div class="kumuliert-label">kumuliert</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Projekte Table -->
                            <div class="chart-panel projekte-panel">
                                <div class="chart-header">
                                    <div class="chart-title">Projekte</div>
                                </div>
                                <div class="projekte-mini-table">
                                    <div class="projekt-row">
                                        <div class="projekt-col">
                                            <div class="projekt-label">Projektstart</div>
                                            <div class="projekt-label">Projektende</div>
                                            <div class="projekt-label">Kosten [T‚Ç¨]</div>
                                        </div>
                                    </div>
                                    <div class="projekt-row">
                                        <div class="projekt-name">WCAR_V_BM | WCAR | Verdrahtung Best Match</div>
                                        <div class="projekt-details">
                                            <div class="projekt-value">Dez 24</div>
                                            <div class="projekt-value">-</div>
                                            <div class="projekt-value">
                                                <div>10.317</div>
                                                <div>785</div>
                                                <div>5.900</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="projekt-row">
                                        <div class="projekt-name">WCAR_V_Z | WCAR | Verdrahtung Zielzustand</div>
                                        <div class="projekt-details">
                                            <div class="projekt-value">-</div>
                                            <div class="projekt-value">-</div>
                                            <div class="projekt-value">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bottom Row: Wirtschaftlichkeit -->
                        <div class="charts-row-bottom">
                            <!-- DB3 pro Jahr -->
                            <div class="chart-panel">
                                <div class="chart-header">
                                    <div class="chart-title">DB 3 pro Jahr**</div>
                                    <div class="chart-info">in Mio. ‚Ç¨</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="db3-jahr-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- DB3 kumuliert -->
                            <div class="chart-panel">
                                <div class="chart-header">
                                    <div class="chart-title">DB 3 kumuliert**</div>
                                    <div class="chart-info">in Mio. ‚Ç¨</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="db3-kumuliert-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Amortisation & Szenarien -->
                            <div class="chart-panel">
                                <div class="chart-header">
                                    <div class="chart-title">Amortisation***</div>
                                    <div class="chart-info">in Jahren</div>
                                </div>
                                <div class="amortisation-display">
                                    <div class="amortisation-value" id="amortisation-value">3,4</div>
                                    <div class="amortisation-label">Jahre</div>
                                </div>
                                
                                <div class="szenarien-box">
                                    <div class="szenarien-title">Szenarien****</div>
                                    <div class="szenarien-grid">
                                        <div class="szenario-row">
                                            <span>Preise</span>
                                            <span id="sz-price">+/-0%</span>
                                        </div>
                                        <div class="szenario-row">
                                            <span>Mengen</span>
                                            <span id="sz-volume">+/-0%</span>
                                        </div>
                                        <div class="szenario-row">
                                            <span>HK</span>
                                            <span id="sz-costs">+/-0%</span>
                                        </div>
                                        <div class="szenario-row">
                                            <span>Projektkosten</span>
                                            <span id="sz-capex">+/-0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Content: Annahmen -->
                <div class="tab-content" id="tab-assumptions">
                    <div class="assumptions-container">
                        
                        <!-- Artikel Portfolio Overview (Hauptebene) -->
                        <div class="assumptions-section" id="artikel-overview">
                            <div class="section-title">üì¶ Artikel Portfolio - Erweiterte Ansicht</div>
                            
                            <div class="artikel-grid">
                                <!-- Crimpautomat -->
                                <div class="artikel-card" onclick="openArtikelDetail('crimp')">
                                    <div class="artikel-header">
                                        <div class="artikel-name">Crimpautomat</div>
                                        <div class="artikel-effect neu-produkt">Neu-Produkt</div>
                                    </div>
                                    <div class="artikel-details">
                                        <div class="detail-row">
                                            <span class="detail-label">Release:</span>
                                            <span class="detail-value">Dez 2024</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Peak Menge:</span>
                                            <span class="detail-value">5.000</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Start-Preis:</span>
                                            <span class="detail-value">5,00‚Ç¨</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Preis-Steigerung:</span>
                                            <span class="detail-value">+3% p.a.</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">DB2 (√ò):</span>
                                            <span class="detail-value success">37%</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Total Revenue:</span>
                                            <span class="detail-value success">87,2M‚Ç¨</span>
                                        </div>
                                    </div>
                                    <div class="artikel-assumptions">
                                        <strong>Annahmen:</strong> Innovation durch neue Linie
                                    </div>
                                </div>
                                
                                <!-- Mini-Komax -->
                                <div class="artikel-card" onclick="openArtikelDetail('komax')">
                                    <div class="artikel-header">
                                        <div class="artikel-name">Mini-Komax ohne CORE</div>
                                        <div class="artikel-effect neu-produkt">Neu-Produkt</div>
                                    </div>
                                    <div class="artikel-details">
                                        <div class="detail-row">
                                            <span class="detail-label">Release:</span>
                                            <span class="detail-value">Dez 2024</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Peak Menge:</span>
                                            <span class="detail-value">115</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Start-Preis:</span>
                                            <span class="detail-value">1.000,00‚Ç¨</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Preis-Steigerung:</span>
                                            <span class="detail-value">+2% p.a.</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">DB2 (√ò):</span>
                                            <span class="detail-value success">31%</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Total Revenue:</span>
                                            <span class="detail-value success">24,8M‚Ç¨</span>
                                        </div>
                                    </div>
                                    <div class="artikel-assumptions">
                                        <strong>Annahmen:</strong> Premium-Segment erschlie√üen
                                    </div>
                                </div>
                                
                                <!-- Digital Shopfloor -->
                                <div class="artikel-card" onclick="openArtikelDetail('digital')">
                                    <div class="artikel-header">
                                        <div class="artikel-name">Digital Shopfloor Backend</div>
                                        <div class="artikel-effect cross-selling">Cross-Selling</div>
                                    </div>
                                    <div class="artikel-details">
                                        <div class="detail-row">
                                            <span class="detail-label">Release:</span>
                                            <span class="detail-value">Jun 2025</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Peak Menge:</span>
                                            <span class="detail-value">250</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Start-Preis:</span>
                                            <span class="detail-value">480,00‚Ç¨</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Preis-Steigerung:</span>
                                            <span class="detail-value">Fixpreis</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">DB2 (√ò):</span>
                                            <span class="detail-value success">58%</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Total Revenue:</span>
                                            <span class="detail-value success">5,8M‚Ç¨</span>
                                        </div>
                                    </div>
                                    <div class="artikel-assumptions">
                                        <strong>Annahmen:</strong> 40% Aufteilung mit Best√ºckung
                                    </div>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="add-artikel-btn" onclick="addNewArtikel()">
                                    ‚ûï Neuer Artikel hinzuf√ºgen
                                </button>
                            </div>
                        </div>
                        
                        <!-- Artikel Detail View mit Sub-Tabs (initially hidden) -->
                        <div class="artikel-detail-view" id="artikel-detail-view" style="display: none;">
                            
                            <!-- Detail Header mit Zur√ºck-Button -->
                            <div class="detail-header">
                                <div class="detail-title">
                                    <span id="current-artikel-name">Artikel bearbeiten</span>
                                </div>
                                <button class="back-btn" onclick="backToArtikelOverview()">
                                    ‚Üê Zur√ºck zur Artikel-√úbersicht
                                </button>
                            </div>
                            
                            <!-- Sub-Tab Navigation -->
                            <div class="sub-tab-navigation">
                                <button class="sub-tab-btn active" onclick="switchSubTab('artikel')">
                                    üì¶ Artikel
                                </button>
                                <button class="sub-tab-btn" onclick="switchSubTab('projekte')">
                                    üèóÔ∏è Projekte
                                </button>
                                <button class="sub-tab-btn" onclick="switchSubTab('wirtschaftlichkeit')">
                                    üí∞ Wirtschaftlichkeit
                                </button>
                            </div>
                            
                            <!-- Sub-Tab Content Container -->
                            <div id="sub-tab-content-container"></div>
                            
                        </div>
                    </div>
                </div>
                
                <!-- Tab Content: Analyse -->
                <div class="tab-content" id="tab-analysis">
                    <div class="analysis-container">
                        <div class="section-title">üìà Detaillierte Business Case Analyse</div>
                        <p>
                            Erweiterte Analyse-Features werden hier implementiert:<br>
                            ‚Ä¢ Sensitivit√§tsanalyse<br>
                            ‚Ä¢ Monte-Carlo-Simulation<br>
                            ‚Ä¢ Benchmark-Vergleiche<br>
                            ‚Ä¢ Risk Assessment
                        </p>
                    </div>
                </div>
                
                <!-- Tab Content: KI Agenten -->
                <div class="tab-content" id="tab-ai-agents">
                    <div style="padding: 30px; background: var(--white); border-radius: 12px; margin: 20px;">
                        <!-- KI Context Detection Panel -->
                        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 1px solid #bfdbfe;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #1e40af;">üß† KI Kontext-Erkennung</h3>
                                <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 6px 12px; border-radius: 20px;">
                                    <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></span>
                                    <span style="font-size: 12px; font-weight: 600;">KI Aktiv</span>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 8px; padding: 20px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #1e293b;">
                                    Business Case Beschreibung eingeben:
                                </label>
                                <textarea id="context-input" style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; resize: vertical;" 
                                          placeholder="z.B. 'Neue CRM Software f√ºr Mittelstand' oder 'Schaltschrankkomponenten f√ºr Automotive' oder 'Beratungsdienstleistung f√ºr Pharma'"></textarea>
                                <button onclick="analyzeContext()" style="margin-top: 15px; padding: 12px 30px; background: linear-gradient(135deg, #4f46e5, #6366f1); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                    üîç Kontext analysieren
                                </button>
                                
                                <div id="analysis-process" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                    <div class="analysis-step" style="display: flex; align-items: center; margin-bottom: 12px;">
                                        <span class="step-icon" style="margin-right: 12px;">‚è≥</span>
                                        <span class="step-text">Analysiere Asset-Typ...</span>
                                    </div>
                                    <div class="analysis-step" style="display: flex; align-items: center; margin-bottom: 12px;">
                                        <span class="step-icon" style="margin-right: 12px;">‚è≥</span>
                                        <span class="step-text">Erkenne Branche...</span>
                                    </div>
                                    <div class="analysis-step" style="display: flex; align-items: center; margin-bottom: 12px;">
                                        <span class="step-icon" style="margin-right: 12px;">‚è≥</span>
                                        <span class="step-text">Identifiziere Gesch√§ftsmodell...</span>
                                    </div>
                                    <div class="analysis-step" style="display: flex; align-items: center;">
                                        <span class="step-icon" style="margin-right: 12px;">‚è≥</span>
                                        <span class="step-text">Lade relevante KPIs...</span>
                                    </div>
                                </div>
                                
                                <div id="context-result" style="display: none; margin-top: 20px;">
                                    <!-- Results will be inserted here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- KI Training Playbook -->
                        <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);">
                            <h3 style="margin: 0 0 20px 0; color: #1e293b;">üìö KI Training & Playbook</h3>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; background: #f1f5f9; padding: 5px; border-radius: 8px;">
                                <button class="playbook-tab-btn active" onclick="switchPlaybook('asset-types')" style="padding: 10px 20px; border: none; background: white; border-radius: 6px; cursor: pointer; font-weight: 600;">Asset-Typen</button>
                                <button class="playbook-tab-btn" onclick="switchPlaybook('industries')" style="padding: 10px 20px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 600;">Branchen</button>
                                <button class="playbook-tab-btn" onclick="switchPlaybook('rules')" style="padding: 10px 20px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 600;">Validierung</button>
                                <button class="playbook-tab-btn" onclick="switchPlaybook('test')" style="padding: 10px 20px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 600;">Test Console</button>
                            </div>
                            
                            <!-- Asset Types Playbook -->
                            <div id="playbook-asset-types" class="playbook-section" style="display: block;">
                                <h4 style="margin: 0 0 20px 0; color: #475569;">Asset-Typ Definitionen</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                                    <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 20px;">
                                        <h5 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 24px;">üì±</span> Software
                                        </h5>
                                        <p style="margin: 0 0 8px 0; font-size: 13px;"><strong>Indikatoren:</strong> SaaS, Cloud, Lizenz, API, Platform</p>
                                        <p style="margin: 0 0 8px 0; font-size: 13px;"><strong>Kostenstruktur:</strong> 5-20% variable Kosten</p>
                                        <p style="margin: 0 0 12px 0; font-size: 13px;"><strong>Kritische KPIs:</strong> ARR, CAC, LTV, Churn</p>
                                        <button onclick="editAssetType('software')" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Bearbeiten</button>
                                    </div>
                                    
                                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 20px;">
                                        <h5 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 24px;">üè≠</span> Hardware
                                        </h5>
                                        <p style="margin: 0 0 8px 0; font-size: 13px;"><strong>Indikatoren:</strong> Produkt, Ger√§t, Maschine, Komponente</p>
                                        <p style="margin: 0 0 8px 0; font-size: 13px;"><strong>Kostenstruktur:</strong> 40-70% variable Kosten</p>
                                        <p style="margin: 0 0 12px 0; font-size: 13px;"><strong>Kritische KPIs:</strong> NPV, ROCE, Break-Even</p>
                                        <button onclick="editAssetType('hardware')" style="padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Bearbeiten</button>
                                    </div>
                                    
                                    <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px;">
                                        <h5 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 24px;">üíº</span> Service
                                        </h5>
                                        <p style="margin: 0 0 8px 0; font-size: 13px;"><strong>Indikatoren:</strong> Beratung, Dienstleistung, Support</p>
                                        <p style="margin: 0 0 8px 0; font-size: 13px;"><strong>Kostenstruktur:</strong> 60-80% Personalkosten</p>
                                        <p style="margin: 0 0 12px 0; font-size: 13px;"><strong>Kritische KPIs:</strong> Utilization, Tagessatz, FTE</p>
                                        <button onclick="editAssetType('service')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Bearbeiten</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Industries Playbook -->
                            <div id="playbook-industries" class="playbook-section" style="display: none;">
                                <h4 style="margin: 0 0 20px 0; color: #475569;">Branchen-Spezifikationen</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    <div style="background: #f8f9fa; border-left: 4px solid #ef4444; padding: 15px; border-radius: 4px;">
                                        <h5 style="margin: 0 0 10px 0;">üöó Automotive</h5>
                                        <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                                            <li>Zahlungsziel: 60-90 Tage</li>
                                            <li>Qualit√§t: PPM < 50</li>
                                            <li>Zertifizierung: IATF 16949</li>
                                        </ul>
                                    </div>
                                    <div style="background: #f8f9fa; border-left: 4px solid #8b5cf6; padding: 15px; border-radius: 4px;">
                                        <h5 style="margin: 0 0 10px 0;">üíä Pharma</h5>
                                        <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                                            <li>Regulatorik: FDA/EMA</li>
                                            <li>Entwicklung: 10+ Jahre</li>
                                            <li>Marge: 60-80%</li>
                                        </ul>
                                    </div>
                                    <div style="background: #f8f9fa; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 4px;">
                                        <h5 style="margin: 0 0 10px 0;">üèóÔ∏è Maschinenbau</h5>
                                        <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                                            <li>Investitionszyklus: 5-7 Jahre</li>
                                            <li>After-Sales: 20-30%</li>
                                            <li>Export: >50%</li>
                                        </ul>
                                    </div>
                                    <div style="background: #f8f9fa; border-left: 4px solid #10b981; padding: 15px; border-radius: 4px;">
                                        <h5 style="margin: 0 0 10px 0;">üíª IT/Tech</h5>
                                        <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                                            <li>Time-to-Market: < 6 Monate</li>
                                            <li>Skalierung: Exponentiell</li>
                                            <li>Cloud-First Strategy</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Validation Rules -->
                            <div id="playbook-rules" class="playbook-section" style="display: none;">
                                <h4 style="margin: 0 0 20px 0; color: #475569;">Validierungs-Regeln</h4>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                        <span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">WENN</span>
                                        <input type="text" value="Software && HK > 30%" readonly style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; background: white;">
                                        <span style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">DANN</span>
                                        <input type="text" value="Warnung: Ungew√∂hnlich hohe Kosten" readonly style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; background: white;">
                                        <button style="padding: 6px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer;">‚úèÔ∏è</button>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                        <span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">WENN</span>
                                        <input type="text" value="Hardware && Wachstum > 200%" readonly style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; background: white;">
                                        <span style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">DANN</span>
                                        <input type="text" value="Kritisch: Unrealistisches Wachstum" readonly style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; background: white;">
                                        <button style="padding: 6px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer;">‚úèÔ∏è</button>
                                    </div>
                                    
                                    <button onclick="addValidationRule()" style="padding: 12px; background: linear-gradient(135deg, #10b981, #34d399); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                        + Neue Regel hinzuf√ºgen
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Test Console -->
                            <div id="playbook-test" class="playbook-section" style="display: none;">
                                <h4 style="margin: 0 0 20px 0; color: #475569;">üß™ Test Console</h4>
                                <div style="background: #1e293b; border-radius: 8px; padding: 20px; color: #e2e8f0;">
                                    <label style="display: block; margin-bottom: 10px; font-size: 12px; text-transform: uppercase;">Test-Szenario:</label>
                                    <select id="test-scenario" onchange="loadTestScenario()" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #334155; border: 1px solid #475569; border-radius: 4px; color: white;">
                                        <option value="">-- W√§hle Szenario --</option>
                                        <option value="saas">SaaS B2B Software</option>
                                        <option value="hardware-auto">Hardware Automotive</option>
                                        <option value="consulting">Consulting Service</option>
                                    </select>
                                    
                                    <label style="display: block; margin-bottom: 10px; font-size: 12px; text-transform: uppercase;">Oder eigene Eingabe:</label>
                                    <textarea id="test-input" style="width: 100%; min-height: 60px; padding: 10px; margin-bottom: 15px; background: #334155; border: 1px solid #475569; border-radius: 4px; color: white; font-family: monospace;" 
                                              placeholder="Beschreibe deinen Business Case..."></textarea>
                                    
                                    <button onclick="runAITest()" style="padding: 10px 20px; background: linear-gradient(135deg, #f59e0b, #fbbf24); color: #1e293b; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                        üöÄ Test ausf√ºhren
                                    </button>
                                    
                                    <div id="test-output" style="margin-top: 20px; padding: 15px; background: #0f172a; border-radius: 4px; font-family: monospace; font-size: 13px; min-height: 100px; display: none;">
                                        <!-- Test results appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KI Agent Status -->
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%); border-radius: 12px; padding: 25px; border: 1px solid #fbbf24;">
                            <h3 style="margin: 0 0 20px 0; color: #92400e;">ü§ñ Controller Agent Status</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center;">
                                    <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">156</div>
                                    <div style="font-size: 12px; color: #92400e; margin-top: 5px;">Trainierte Muster</div>
                                </div>
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center;">
                                    <div style="font-size: 28px; font-weight: bold; color: #10b981;">94%</div>
                                    <div style="font-size: 12px; color: #92400e; margin-top: 5px;">Genauigkeit</div>
                                </div>
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center;">
                                    <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">0.3s</div>
                                    <div style="font-size: 12px; color: #92400e; margin-top: 5px;">Antwortzeit</div>
                                </div>
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center;">
                                    <div style="font-size: 28px; font-weight: bold; color: #8b5cf6;">847</div>
                                    <div style="font-size: 12px; color: #92400e; margin-top: 5px;">Analysen heute</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced KI Sidebar -->
            <div class="sidebar">
                <!-- KI Status Header -->
                <div class="ai-header">
                    <div class="ai-status">
                        <div class="ai-status-indicator"></div>
                        <span style="font-size: 14px; font-weight: 600;">KI-Controller aktiv</span>
                    </div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 4px;">
                        Echtzeit-Analyse ‚Ä¢ 1.400+ Finance-Patterns ‚Ä¢ Industrie-Benchmarks
                    </div>
                </div>
                
                <!-- KI Metrics Panel -->
                <div class="ai-metrics-panel">
                    <div class="ai-metric-row">
                        <span class="ai-metric-label">Business Case Status:</span>
                        <span class="ai-metric-value good" id="bc-status">‚úì Positiv</span>
                    </div>
                    <div class="ai-metric-row">
                        <span class="ai-metric-label">Risiko-Level:</span>
                        <span class="ai-metric-value warning" id="risk-level">Medium (68%)</span>
                    </div>
                    <div class="ai-metric-row">
                        <span class="ai-metric-label">Konfidenz-Score:</span>
                        <span class="ai-metric-value" id="confidence">78%</span>
                    </div>
                    <div class="ai-metric-row">
                        <span class="ai-metric-label">vs. Industrie-Benchmark:</span>
                        <span class="ai-metric-value good" id="benchmark">+12% besser</span>
                    </div>
                </div>
                
                <!-- KI Feed -->
                <div class="ai-feed" id="ai-feed">
                    <div class="ai-feed-title">
                        ü§ñ KI-Analyse & Empfehlungen
                    </div>
                </div>
                
                <!-- KI Actions -->
                <div class="ai-actions">
                    <button class="ai-action-btn primary" onclick="aiAction('deep-analysis')">
                        üîç Deep Dive Analyse starten
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('stress-test')">
                        üî¨ Stress-Test Worst-Case
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('sensitivity')">
                        üìä Sensitivit√§ts-Analyse
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('benchmark')">
                        ‚öñÔ∏è Industrie-Benchmark
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('monte-carlo')">
                        üé≤ Monte-Carlo-Simulation
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('export')">
                        üìÑ Board-Export generieren
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Global dashboard data with KI intelligence
        let cfoDashboard = {
            currentArtikel: null,
            currentValues: {
                marketVolume: 100,
                pricePremium: 100,
                capexRisk: 100,
                npv: 44.7,
                payback: 3.4,
                revenue: 117.8,
                db2Margin: 34,
                capexTotal: 18.8
            },
            benchmarks: {
                db2Margin: { min: 25, target: 35, max: 45, industry: 32 },
                payback: { excellent: 2, good: 3, acceptable: 4, critical: 5, industry: 4.1 },
                capexVariance: { green: 10, yellow: 20, red: 30 },
                marketGrowth: { conservative: 5, moderate: 10, aggressive: 15 },
                npvROI: { min: 50, target: 150, excellent: 200 }
            },
            historicalData: {
                lastMarketVolume: 100,
                lastPricePremium: 100,
                lastCapexRisk: 100
            },
            aiController: {
                messageHistory: [],
                patternLibrary: [
                    {
                        id: 'working_capital_trap',
                        name: 'Working Capital Trap',
                        check: () => cfoDashboard.currentValues.payback > 4 && cfoDashboard.currentValues.db2Margin < 30,
                        severity: 'critical',
                        message: 'Working Capital Falle erkannt! Zu lange Kapitalbindung bei schwacher Marge.',
                        recommendation: 'Zahlungsziele verk√ºrzen, Lagerumschlag erh√∂hen, Factoring pr√ºfen.'
                    },
                    {
                        id: 'premium_pricing_risk',
                        name: 'Premium Pricing Risiko',
                        check: () => cfoDashboard.currentValues.pricePremium > 115,
                        severity: 'warning',
                        message: 'Premium-Pricing >15% historisch nicht nachhaltig in Maschinenbau.',
                        recommendation: 'Elastizit√§t testen, Value Proposition st√§rken, Preisanker setzen.'
                    },
                    {
                        id: 'scale_economics',
                        name: 'Skaleneffekte',
                        check: () => cfoDashboard.currentValues.marketVolume > 120 && cfoDashboard.currentValues.db2Margin > 35,
                        severity: 'success',
                        message: 'Skaleneffekte realisierbar! Volume-Bonus und Lernkurve nutzbar.',
                        recommendation: 'Kapazit√§t ausbauen, Automation pr√ºfen, Rahmenvertr√§ge verhandeln.'
                    },
                    {
                        id: 'capex_overrun',
                        name: 'CAPEX √úberinvestment',
                        check: () => cfoDashboard.currentValues.capexRisk > 120 && cfoDashboard.currentValues.payback > 3.5,
                        severity: 'critical',
                        message: 'CAPEX-Explosion bei bereits kritischer Payback-Zeit!',
                        recommendation: 'Projekt-Stopp evaluieren, Phasing implementieren, Scope reduzieren.'
                    },
                    {
                        id: 'market_collapse',
                        name: 'Markt-Kollaps',
                        check: () => cfoDashboard.currentValues.marketVolume < 70,
                        severity: 'critical',
                        message: 'Marktvolumen unter kritischer Schwelle - Verlustzone droht!',
                        recommendation: 'Notfall-Plan aktivieren: Fixkosten -30%, nur profitable SKUs, Cash-Preservation.'
                    }
                ],
                
                analyzeMetric: function(type, value, context) {
                    const analyses = {
                        db2Margin: (margin) => {
                            const bench = cfoDashboard.benchmarks.db2Margin;
                            if (margin < bench.min) {
                                return {
                                    level: 'critical',
                                    text: `DB2-Marge ${margin.toFixed(1)}% kritisch unter Minimum (${bench.min}%)! Projekt-Fortf√ºhrung gef√§hrdet.`,
                                    recommendation: 'Sofortige Preiserh√∂hung um mind. 8% oder Kostensenkung um 15% erforderlich.',
                                    impact: `NPV sinkt auf ${(cfoDashboard.currentValues.npv * 0.3).toFixed(1)}M‚Ç¨`,
                                    actions: ['Emergency-Meeting einberufen', 'Pricing-Strategie √ºberarbeiten', 'Lieferanten neu verhandeln']
                                };
                            }
                            if (margin < bench.target) {
                                return {
                                    level: 'warning',
                                    text: `DB2-Marge ${margin.toFixed(1)}% unter Target (${bench.target}%). Optimierungspotential vorhanden.`,
                                    recommendation: 'Preis-Kosten-Schere optimieren. Fokus auf High-Margin Produkte.',
                                    impact: 'ROI um ca. 20% reduziert',
                                    actions: ['Value-Engineering Workshop', 'Produktmix anpassen']
                                };
                            }
                            if (margin > bench.max) {
                                return {
                                    level: 'warning',
                                    text: `DB2-Marge ${margin.toFixed(1)}% ungew√∂hnlich hoch (>${bench.max}%). Nachhaltigkeit fraglich.`,
                                    recommendation: 'Wettbewerbsanalyse durchf√ºhren - Preiserosion wahrscheinlich.',
                                    impact: 'Marktanteil-Verlust von 10-15% m√∂glich',
                                    actions: ['Competitor-Analyse', 'Preissenkung vorbereiten', 'USPs st√§rken']
                                };
                            }
                            return {
                                level: 'success',
                                text: `DB2-Marge ${margin.toFixed(1)}% optimal (Zielkorridor ${bench.min}-${bench.max}%).`,
                                recommendation: 'Status quo beibehalten, kontinuierliche Optimierung.',
                                impact: 'Nachhaltige Profitabilit√§t gesichert'
                            };
                        },
                        
                        payback: (years) => {
                            const bench = cfoDashboard.benchmarks.payback;
                            if (years <= bench.excellent) {
                                return {
                                    level: 'success',
                                    text: `Payback ${years.toFixed(1)}J exzellent! Top 10% aller Projekte.`,
                                    recommendation: 'Investment-Case sehr stark. Skalierung/Expansion pr√ºfen.',
                                    impact: 'IRR > 30% - deutlich √ºber WACC'
                                };
                            }
                            if (years <= bench.good) {
                                return {
                                    level: 'success',
                                    text: `Payback ${years.toFixed(1)}J sehr gut (Industrie: ${bench.industry}J).`,
                                    recommendation: 'Projekt planm√§√üig umsetzen.',
                                    impact: '√úberdurchschnittliche Performance'
                                };
                            }
                            if (years <= bench.acceptable) {
                                return {
                                    level: 'info',
                                    text: `Payback ${years.toFixed(1)}J akzeptabel, aber Optimierung m√∂glich.`,
                                    recommendation: 'Beschleunigungsm√∂glichkeiten identifizieren.',
                                    impact: 'Im Industriestandard',
                                    actions: ['Time-to-Market verk√ºrzen', 'Ramp-up beschleunigen']
                                };
                            }
                            if (years <= bench.critical) {
                                return {
                                    level: 'warning',
                                    text: `Payback ${years.toFixed(1)}J grenzwertig! Kapitalbindung problematisch.`,
                                    recommendation: 'Projekt-Scope reduzieren oder Phasenmodell.',
                                    impact: 'ROI unter Mindestschwelle',
                                    actions: ['Scope-Review', 'Phasing-Plan erstellen', 'Quick-Wins identifizieren']
                                };
                            }
                            return {
                                level: 'critical',
                                text: `Payback ${years.toFixed(1)}J kritisch! Investment nicht vertretbar.`,
                                recommendation: 'Projekt stoppen oder fundamental √ºberarbeiten.',
                                impact: 'Vernichtung von Shareholder Value',
                                actions: ['Board-Eskalation', 'Exit-Strategie', 'Alternativen evaluieren']
                            };
                        },
                        
                        capexOverrun: (percentage) => {
                            const variance = percentage - 100;
                            const bench = cfoDashboard.benchmarks.capexVariance;
                            const additionalCapex = (variance / 100 * cfoDashboard.currentValues.capexTotal).toFixed(1);
                            
                            if (Math.abs(variance) <= bench.green) {
                                return {
                                    level: 'success',
                                    text: `CAPEX im Plan (${variance > 0 ? '+' : ''}${variance.toFixed(0)}%). Kostenkontrolle funktioniert.`,
                                    recommendation: 'Weiter so - Projektmanagement effektiv.',
                                    impact: 'Keine Auswirkung auf Business Case'
                                };
                            }
                            if (Math.abs(variance) <= bench.yellow) {
                                return {
                                    level: 'warning',
                                    text: `CAPEX-Abweichung ${variance > 0 ? '+' : ''}${variance.toFixed(0)}% (${variance > 0 ? '+' : ''}${additionalCapex}M‚Ç¨).`,
                                    recommendation: 'Steering Committee einberufen. Gegenma√ünahmen definieren.',
                                    impact: `Payback verl√§ngert um ${(variance * 0.03).toFixed(1)} Jahre`,
                                    actions: ['Cost-Review Meeting', 'Contingency nutzen', 'Savings identifizieren']
                                };
                            }
                            return {
                                level: 'critical',
                                text: `CAPEX-√úberschreitung ${variance.toFixed(0)}% kritisch! +${additionalCapex}M‚Ç¨ zus√§tzlich.`,
                                recommendation: 'Projekt-Stopp pr√ºfen. Board-Eskalation erforderlich.',
                                impact: `NPV sinkt um ${(variance * 0.5).toFixed(0)}M‚Ç¨, IRR unter Hurdle Rate`,
                                actions: ['Notfall-Board einberufen', 'Projekt pausieren', 'Re-Baseline durchf√ºhren']
                            };
                        },
                        
                        marketScenario: (volume) => {
                            const change = volume - 100;
                            if (change < -30) {
                                return {
                                    level: 'critical',
                                    text: `Markt-Kollaps ${change}%! Sofort in Krisen-Modus wechseln.`,
                                    recommendation: 'Cash-Preservation aktivieren. Nur profitable Core-Produkte.',
                                    impact: `Break-Even nicht erreichbar, Verlust von ${Math.abs(change * 0.5).toFixed(0)}M‚Ç¨`,
                                    actions: ['Produktion drosseln', 'Kurzarbeit pr√ºfen', 'Working Capital optimieren', 'Notverk√§ufe stoppen']
                                };
                            }
                            if (change < -10) {
                                return {
                                    level: 'warning',
                                    text: `Markt-Abschwung ${change}%. Defensive Strategie erforderlich.`,
                                    recommendation: 'Kosten variabilisieren, Investitionen verschieben.',
                                    impact: `NPV reduziert auf ${(cfoDashboard.currentValues.npv * (volume/100)).toFixed(1)}M‚Ç¨`,
                                    actions: ['CAPEX-Freeze', 'Einstellungsstopp', 'Preis-Promotions']
                                };
                            }
                            if (change > 20) {
                                return {
                                    level: 'success',
                                    text: `Markt-Boom +${change}%! Aggressives Wachstum m√∂glich.`,
                                    recommendation: 'Kapazit√§ten ausbauen, First-Mover-Advantage nutzen.',
                                    impact: `NPV steigt auf ${(cfoDashboard.currentValues.npv * (volume/100)).toFixed(1)}M‚Ç¨`,
                                    actions: ['Produktion skalieren', 'Vertrieb verst√§rken', 'M&A-Optionen']
                                };
                            }
                            return {
                                level: 'info',
                                text: `Marktentwicklung ${change > 0 ? '+' : ''}${change}% im erwarteten Rahmen.`,
                                recommendation: 'Planm√§√üige Umsetzung fortsetzen.',
                                impact: 'Business Case stabil'
                            };
                        }
                    };
                    
                    if (analyses[type]) {
                        return analyses[type](value, context);
                    }
                    return { level: 'info', text: 'Analyse l√§uft...', recommendation: '', impact: '' };
                },
                
                generateInsight: function(changeType, oldValue, newValue) {
                    const insights = [];
                    const percentChange = ((newValue - oldValue) / oldValue * 100).toFixed(1);
                    
                    // Intelligente kontextbezogene Insights
                    if (changeType === 'market') {
                        const analysis = this.analyzeMetric('marketScenario', newValue);
                        insights.push({
                            level: analysis.level,
                            title: `üìä Marktvolumen ${newValue}%`,
                            text: analysis.text,
                            recommendation: analysis.recommendation,
                            impact: analysis.impact,
                            actions: analysis.actions,
                            timestamp: 'Echtzeit-Analyse'
                        });
                        
                        // Zus√§tzliche Warnung bei extremen Szenarien
                        if (newValue < 80 || newValue > 130) {
                            insights.push({
                                level: 'warning',
                                title: '‚ö†Ô∏è Extremszenario erkannt',
                                text: `Bei ${percentChange}% Marktver√§nderung: Elastizit√§ten neu berechnen.`,
                                recommendation: 'Szenario-Workshop mit Sales, Operations und Finance.',
                                actions: ['Forecast anpassen', 'Hedging-Strategien', 'Alternativ-Szenarien'],
                                timestamp: 'Risiko-Alert'
                            });
                        }
                    }
                    
                    if (changeType === 'price') {
                        const elasticity = -1.2; // Preiselastizit√§t
                        const volumeImpact = (newValue - 100) * elasticity;
                        const marginImpact = cfoDashboard.currentValues.db2Margin * (newValue / 100);
                        
                        insights.push({
                            level: newValue > 110 ? 'warning' : newValue < 90 ? 'critical' : 'info',
                            title: `üí∞ Preis-Anpassung ${newValue - 100 >= 0 ? '+' : ''}${(newValue - 100).toFixed(0)}%`,
                            text: `Erwarteter Volumeneffekt: ${volumeImpact.toFixed(0)}%. Neue DB2-Marge: ${marginImpact.toFixed(1)}%.`,
                            recommendation: newValue > 110 
                                ? 'Value-Selling intensivieren, USPs kommunizieren.' 
                                : 'Kostenstruktur anpassen, Volumen maximieren.',
                            impact: `NPV-√Ñnderung: ${((newValue - 100) * 0.3).toFixed(1)}M‚Ç¨`,
                            actions: newValue > 110 
                                ? ['Kundengespr√§che f√ºhren', 'Wettbewerbsanalyse', 'Preisanker setzen']
                                : ['Kostensenkungsprogramm', 'Lieferanten-Verhandlung', 'Prozess-Optimierung'],
                            timestamp: 'Preis-Analyse'
                        });
                    }
                    
                    if (changeType === 'capex') {
                        const analysis = this.analyzeMetric('capexOverrun', newValue);
                        insights.push({
                            level: analysis.level,
                            title: `üí∏ CAPEX ${newValue}% von Plan`,
                            text: analysis.text,
                            recommendation: analysis.recommendation,
                            impact: analysis.impact,
                            actions: analysis.actions,
                            timestamp: 'Investment-Kontrolle'
                        });
                    }
                    
                    return insights;
                },
                
                runPatternAnalysis: function() {
                    const detectedPatterns = [];
                    
                    this.patternLibrary.forEach(pattern => {
                        if (pattern.check()) {
                            detectedPatterns.push(pattern);
                        }
                    });
                    
                    if (detectedPatterns.length > 0) {
                        detectedPatterns.forEach(pattern => {
                            this.addAIMessage({
                                level: pattern.severity,
                                title: `üîç Pattern erkannt: ${pattern.name}`,
                                text: pattern.message,
                                recommendation: pattern.recommendation,
                                timestamp: 'Pattern-Analyse'
                            });
                        });
                    }
                    
                    return detectedPatterns;
                },
                
                compareToBenchmarks: function() {
                    const current = cfoDashboard.currentValues;
                    const bench = cfoDashboard.benchmarks;
                    
                    const db2Diff = current.db2Margin - bench.db2Margin.industry;
                    const paybackDiff = current.payback - bench.payback.industry;
                    const roi = (current.npv / current.capexTotal) * 100;
                    
                    return {
                        db2: {
                            value: current.db2Margin,
                            benchmark: bench.db2Margin.industry,
                            diff: db2Diff,
                            rating: db2Diff > 0 ? '√ºberdurchschnittlich' : 'unterdurchschnittlich'
                        },
                        payback: {
                            value: current.payback,
                            benchmark: bench.payback.industry,
                            diff: paybackDiff,
                            rating: paybackDiff < 0 ? 'besser' : 'schlechter'
                        },
                        roi: {
                            value: roi,
                            benchmark: bench.npvROI.target,
                            diff: roi - bench.npvROI.target,
                            rating: roi > bench.npvROI.target ? 'stark' : 'schwach'
                        }
                    };
                },
                
                addAIMessage: function(message) {
                    const container = document.getElementById('ai-feed');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `ai-message ${message.level || ''}`;
                    
                    // Erstelle HTML f√ºr Actions falls vorhanden
                    let actionsHTML = '';
                    if (message.actions && message.actions.length > 0) {
                        actionsHTML = '<div class="message-actions"><strong style="font-size: 11px;">Empfohlene Ma√ünahmen:</strong><ul>';
                        message.actions.forEach(action => {
                            actionsHTML += `<li>${action}</li>`;
                        });
                        actionsHTML += '</ul></div>';
                    }
                    
                    messageDiv.innerHTML = `
                        <div class="message-title">${message.title || 'KI-Analyse'}</div>
                        <div class="message-text">
                            ${message.text}
                            ${message.recommendation ? `<br><strong>Empfehlung:</strong> ${message.recommendation}` : ''}
                            ${message.impact ? `<br><strong>Impact:</strong> ${message.impact}` : ''}
                            ${actionsHTML}
                        </div>
                        <div class="message-timestamp">${message.timestamp || 'gerade eben'}</div>
                    `;
                    container.appendChild(messageDiv);
                    container.scrollTop = container.scrollHeight;
                    
                    // Update Status-Indikatoren basierend auf Severity
                    this.updateStatusIndicators(message.level);
                    
                    // Speichere in History
                    this.messageHistory.push({
                        timestamp: new Date(),
                        message: message
                    });
                    
                    // Trigger Follow-up Analysen bei kritischen Werten
                    if (message.level === 'critical' || message.level === 'warning') {
                        setTimeout(() => this.triggerRiskAssessment(), 2000);
                    }
                },
                
                updateStatusIndicators: function(level) {
                    const statusEl = document.getElementById('bc-status');
                    const riskEl = document.getElementById('risk-level');
                    const confidenceEl = document.getElementById('confidence');
                    
                    if (level === 'critical') {
                        statusEl.textContent = '‚ö†Ô∏è Kritisch';
                        statusEl.className = 'ai-metric-value critical';
                        riskEl.textContent = 'Hoch (85%)';
                        riskEl.className = 'ai-metric-value critical';
                        confidenceEl.textContent = '45%';
                    } else if (level === 'warning') {
                        statusEl.textContent = '‚ö° Review n√∂tig';
                        statusEl.className = 'ai-metric-value warning';
                        riskEl.textContent = 'Medium (68%)';
                        riskEl.className = 'ai-metric-value warning';
                        confidenceEl.textContent = '68%';
                    } else if (level === 'success') {
                        statusEl.textContent = '‚úì Positiv';
                        statusEl.className = 'ai-metric-value good';
                        riskEl.textContent = 'Niedrig (32%)';
                        riskEl.className = 'ai-metric-value good';
                        confidenceEl.textContent = '85%';
                    }
                },
                
                triggerRiskAssessment: function() {
                    const risks = [];
                    const current = cfoDashboard.currentValues;
                    
                    if (current.db2Margin < 30) risks.push('Margenerosion');
                    if (current.payback > 4) risks.push('Lange Kapitalbindung');
                    if (current.capexRisk > 115) risks.push('CAPEX-√úberschreitung');
                    if (current.marketVolume < 85) risks.push('Marktrisiko');
                    if (current.pricePremium > 110) risks.push('Preisakzeptanz');
                    
                    if (risks.length > 2) {
                        this.addAIMessage({
                            level: 'warning',
                            title: 'üö® Automatische Risikoanalyse',
                            text: `${risks.length} kritische Risiken identifiziert.`,
                            recommendation: 'Sofortiges Risk-Mitigation Meeting erforderlich.',
                            actions: risks.map(risk => `${risk} addressieren`),
                            timestamp: 'Risiko-Scan'
                        });
                    }
                }
            }
        };

        // Tab switching functionality
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activate selected tab
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Add KI message about tab switch
            const aiMessages = {
                'dashboard': {
                    title: 'üìä Dashboard-Ansicht',
                    text: 'Executive View aktiviert. Live-Charts und KPIs f√ºr schnelle Business Case Bewertung.',
                    level: 'info'
                },
                'assumptions': {
                    title: '‚öôÔ∏è Annahmen-Modus',
                    text: 'Artikel-Portfolio bereit zur Bearbeitung. Parameter-Anpassungen werden in Echtzeit berechnet.',
                    level: 'success'
                },
                'analysis': {
                    title: 'üìà Analyse-Modus',
                    text: 'Deep-Analytics verf√ºgbar. Sensitivit√§t, Monte-Carlo und Benchmarks abrufbar.',
                    level: 'info'
                }
            };
            
            if (aiMessages[tabName]) {
                cfoDashboard.aiController.addAIMessage({
                    ...aiMessages[tabName],
                    timestamp: 'Navigation'
                });
            }
        }

        // Dashboard control functions
        function adjustAssumption(type, value) {
            const oldValue = cfoDashboard.historicalData[`last${type.charAt(0).toUpperCase() + type.slice(1)}${type === 'market' ? 'Volume' : type === 'price' ? 'Premium' : 'Risk'}`];
            
            // Update display values
            switch(type) {
                case 'market':
                    cfoDashboard.currentValues.marketVolume = parseInt(value);
                    document.getElementById('market-value').textContent = value + '%';
                    document.getElementById('sz-volume').textContent = `${value > 100 ? '+' : ''}${(value - 100).toFixed(0)}%`;
                    break;
                case 'price':
                    cfoDashboard.currentValues.pricePremium = parseInt(value);
                    const priceDiff = value - 100;
                    document.getElementById('price-value').textContent = (priceDiff >= 0 ? '+' : '') + priceDiff + '%';
                    document.getElementById('sz-price').textContent = `${priceDiff >= 0 ? '+' : ''}${priceDiff}%`;
                    break;
                case 'capex':
                    cfoDashboard.currentValues.capexRisk = parseInt(value);
                    const capexText = value > 110 ? '√úberschreitung' : value < 90 ? 'Einsparung' : 'Plan';
                    document.getElementById('capex-value').textContent = capexText;
                    document.getElementById('sz-capex').textContent = `${value > 100 ? '+' : ''}${(value - 100).toFixed(0)}%`;
                    break;
            }
            
            // Update metrics
            updateMetrics(type, parseInt(value));
            
            // Generate AI insights
            const insights = cfoDashboard.aiController.generateInsight(type, oldValue, parseInt(value));
            insights.forEach(insight => {
                cfoDashboard.aiController.addAIMessage(insight);
            });
            
            // Run pattern analysis if significant change
            if (Math.abs(parseInt(value) - oldValue) > 10) {
                setTimeout(() => {
                    cfoDashboard.aiController.runPatternAnalysis();
                }, 1000);
            }
            
            // Update historical data
            cfoDashboard.historicalData[`last${type.charAt(0).toUpperCase() + type.slice(1)}${type === 'market' ? 'Volume' : type === 'price' ? 'Premium' : 'Risk'}`] = parseInt(value);
        }

        function updateMetrics(type, value) {
            // Impact calculations
            const impacts = {
                market: { npv: 0.447, payback: -0.02, revenue: 1.178, margin: 0 },
                price: { npv: 0.3, payback: -0.01, revenue: 0, margin: 0.34 },
                capex: { npv: -0.188, payback: 0.034, revenue: 0, margin: 0 }
            };
            
            const baseline = { npv: 44.7, payback: 3.4, revenue: 117.8, margin: 34 };
            const multiplier = (value - 100) / 100;
            
            // Calculate new values
            const newNPV = baseline.npv + (impacts[type].npv * value - impacts[type].npv * 100);
            const newPayback = baseline.payback + (impacts[type].payback * multiplier * 10);
            const newRevenue = baseline.revenue + (impacts[type].revenue * value - impacts[type].revenue * 100);
            const newMargin = baseline.margin + (impacts[type].margin * multiplier);
            
            // Update display
            document.getElementById('npv-value').textContent = (newNPV >= 0 ? '+' : '') + newNPV.toFixed(1) + 'M‚Ç¨';
            document.getElementById('payback-value').textContent = newPayback.toFixed(1) + 'J';
            document.getElementById('revenue-value').textContent = newRevenue.toFixed(1) + 'M‚Ç¨';
            document.getElementById('margin-value').textContent = newMargin.toFixed(0) + '%';
            
            // Update kumuliert display if capex changes
            if (type === 'capex') {
                const newCapex = 18.8 * (value / 100);
                document.getElementById('kumuliert-value').textContent = newCapex.toFixed(1);
            }
            
            // Update amortisation
            document.getElementById('amortisation-value').textContent = newPayback.toFixed(1);
            
            // Store updated values
            cfoDashboard.currentValues.npv = newNPV;
            cfoDashboard.currentValues.payback = newPayback;
            cfoDashboard.currentValues.revenue = newRevenue;
            cfoDashboard.currentValues.db2Margin = newMargin;
            
            // Analyze critical metrics
            if (newPayback > 4 || newMargin < 25) {
                const paybackAnalysis = cfoDashboard.aiController.analyzeMetric('payback', newPayback);
                if (paybackAnalysis.level === 'critical' || paybackAnalysis.level === 'warning') {
                    cfoDashboard.aiController.addAIMessage({
                        level: paybackAnalysis.level,
                        title: '‚è±Ô∏è Payback-Warnung',
                        text: paybackAnalysis.text,
                        recommendation: paybackAnalysis.recommendation,
                        impact: paybackAnalysis.impact,
                        actions: paybackAnalysis.actions,
                        timestamp: 'Metric-Alert'
                    });
                }
            }
            
            // Update benchmark comparison
            const comparison = cfoDashboard.aiController.compareToBenchmarks();
            const benchmarkText = comparison.db2.diff > 0 
                ? `+${comparison.db2.diff.toFixed(0)}% besser` 
                : `${comparison.db2.diff.toFixed(0)}% schlechter`;
            document.getElementById('benchmark').textContent = benchmarkText;
            document.getElementById('benchmark').className = comparison.db2.diff > 0 
                ? 'ai-metric-value good' 
                : 'ai-metric-value warning';
        }

        // Artikel detail navigation
        function openArtikelDetail(artikelId) {
            console.log('Opening detail for artikel:', artikelId);
            
            cfoDashboard.currentArtikel = artikelId;
            
            // Hide overview and show detail view
            document.getElementById('artikel-overview').style.display = 'none';
            document.getElementById('artikel-detail-view').style.display = 'block';
            
            // Load artikel data
            loadArtikelIntoEditor(artikelId);
            
            // Reset to first sub-tab
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.sub-tab-btn').classList.add('active');
            
            // Load first sub-tab content
            switchSubTab('artikel');
            
            // Add KI message
            const artikelNames = {
                'crimp': 'Crimpautomat',
                'komax': 'Mini-Komax ohne CORE',
                'digital': 'Digital Shopfloor Backend'
            };
            
            cfoDashboard.aiController.addAIMessage({
                level: 'success',
                title: 'üì¶ Artikel-Detail ge√∂ffnet',
                text: `${artikelNames[artikelId]} zur Bearbeitung geladen. 3 Bereiche verf√ºgbar: Artikel-Parameter, Projekt-Kosten, Wirtschaftlichkeits-Analyse.`,
                recommendation: 'Verwenden Sie die Sub-Tabs f√ºr detaillierte Konfiguration.',
                timestamp: 'Artikel-Management'
            });
        }
        
        function backToArtikelOverview() {
            // Show overview and hide detail view
            document.getElementById('artikel-overview').style.display = 'block';
            document.getElementById('artikel-detail-view').style.display = 'none';
            
            cfoDashboard.aiController.addAIMessage({
                level: 'info',
                title: 'üìã Zur√ºck zur √úbersicht',
                text: 'Portfolio-Ansicht aktiviert. Alle √Ñnderungen wurden gespeichert.',
                timestamp: 'Navigation'
            });
        }
        
        function switchSubTab(subTabName) {
            // Update button states
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchSubTab('${subTabName}')"]`).classList.add('active');
            
            // Load content based on sub-tab
            const container = document.getElementById('sub-tab-content-container');
            
            switch(subTabName) {
                case 'artikel':
                    container.innerHTML = getArtikelTabContent();
                    loadArtikelData();
                    break;
                case 'projekte':
                    container.innerHTML = getProjekteTabContent();
                    break;
                case 'wirtschaftlichkeit':
                    container.innerHTML = getWirtschaftlichkeitTabContent();
                    break;
            }
            
            // KI Commentary
            const messages = {
                'artikel': {
                    title: 'üì¶ Artikel-Parameter',
                    text: 'Preise, Mengen und Margen editierbar. √Ñnderungen wirken sich direkt auf NPV aus.',
                    recommendation: 'DB2-Marge sollte zwischen 25-45% liegen f√ºr nachhaltigen Business Case.'
                },
                'projekte': {
                    title: 'üèóÔ∏è Projekt-Kosten',
                    text: 'CAPEX und OPEX √ºber Jahre verteilt. Kritisch f√ºr Payback-Berechnung.',
                    recommendation: 'CAPEX-Variance unter 20% halten f√ºr stabilen Business Case.'
                },
                'wirtschaftlichkeit': {
                    title: 'üí∞ Wirtschaftlichkeits-Analyse',
                    text: 'Automatische DB3-Berechnung und Amortisations-Analyse basierend auf Artikel-Revenue und Projekt-Kosten.',
                    recommendation: 'Payback sollte unter 4 Jahren liegen f√ºr Investment-Freigabe.'
                }
            };
            
            if (messages[subTabName]) {
                cfoDashboard.aiController.addAIMessage({
                    level: 'info',
                    ...messages[subTabName],
                    timestamp: 'Sub-Tab'
                });
            }
        }
        
        function getArtikelTabContent() {
            return `
                <div style="padding: 20px;">
                    <!-- Basis-Informationen Section -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 20px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                            üìã Basis-Informationen
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    Artikel-Bezeichnung
                                </label>
                                <input type="text" id="edit-name" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
                            </div>
                            
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    Effekt-Typ
                                </label>
                                <select id="edit-type" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
                                    <option value="neu">Neu-Produkt</option>
                                    <option value="cross">Cross-Selling</option>
                                    <option value="kannibalisierung">Kannibalisierung</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    Release-Datum
                                </label>
                                <input type="month" id="edit-release" value="2024-12" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
                            </div>
                            
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    Umsatzerhaltung
                                </label>
                                <select id="edit-umsatzerhaltung" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
                                    <option value="nein">Nein</option>
                                    <option value="ja">Ja</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                Annahmen & Basis f√ºr Absch√§tzung
                            </label>
                            <textarea id="edit-assumptions" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;">Innovation durch neue Linie</textarea>
                        </div>
                    </div>
                    
                    <!-- Finanz-Parameter Section -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 20px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                            üí∞ Finanz-Parameter
                        </h3>
                        
                        <!-- Aktuelles Jahr Auswahl -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                Jahr ausw√§hlen
                            </label>
                            <select id="year-selector" style="width: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px;" 
                                    onchange="loadYearData(this.value)">
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027" selected>2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        
                        <!-- Parameter Grid f√ºr ausgew√§hltes Jahr -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    Menge (St√ºck)
                                </label>
                                <input type="text" id="param-menge" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; text-align: center;" 
                                       onchange="formatNumberInput(this); calculateFinancials();" onblur="formatNumberInput(this)">
                            </div>
                            
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    Preis (‚Ç¨/St√ºck)
                                </label>
                                <input type="text" id="param-preis" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; text-align: center;" 
                                       onchange="formatDecimalInput(this); calculateFinancials();" onblur="formatDecimalInput(this)">
                            </div>
                            
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    HK pro St√ºck (‚Ç¨)
                                </label>
                                <input type="text" id="param-hk-stueck" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; text-align: center;" 
                                       onchange="formatDecimalInput(this); updateHKProStueck(); calculateFinancials();" onblur="formatDecimalInput(this)">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    Umsatz (‚Ç¨)
                                </label>
                                <div id="param-umsatz" style="padding: 10px; background: var(--gray-light); border-radius: 6px; font-size: 13px; text-align: center; font-weight: 600; color: var(--primary); min-height: 38px; display: flex; align-items: center; justify-content: center;">
                                    0‚Ç¨
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    HK gesamt (‚Ç¨)
                                </label>
                                <div id="param-hk-gesamt" style="padding: 10px; background: var(--gray-light); border-radius: 6px; font-size: 13px; text-align: center; font-weight: 600; color: var(--danger); min-height: 38px; display: flex; align-items: center; justify-content: center;">
                                    0‚Ç¨
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; display: block; margin-bottom: 6px;">
                                    DB2 (%)
                                </label>
                                <div id="param-db2" style="padding: 10px; background: var(--gray-light); border-radius: 6px; font-size: 16px; text-align: center; font-weight: 700; min-height: 38px; display: flex; align-items: center; justify-content: center;">
                                    0%
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gesamt-KPIs -->
                        <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                            <div style="background: white; border: 1px solid var(--border); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary);" id="total-revenue">0‚Ç¨</div>
                                <div style="font-size: 11px; color: var(--gray); text-transform: uppercase;">Total Revenue (6 Jahre)</div>
                            </div>
                            
                            <div style="background: white; border: 1px solid var(--border); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);" id="avg-margin">0%</div>
                                <div style="font-size: 11px; color: var(--gray); text-transform: uppercase;">√ò DB2-Marge</div>
                            </div>
                            
                            <div style="background: white; border: 1px solid var(--border); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--warning);" id="peak-volume">0</div>
                                <div style="font-size: 11px; color: var(--gray); text-transform: uppercase;">Peak Absatz</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Jahres-Entwicklung Section -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 20px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                            üìà Jahres-Entwicklung
                        </h3>
                        
                        <!-- Mengenmodelle Auswahl -->
                        <div style="margin-bottom: 20px; padding: 16px; background: #f0f9ff; border-radius: 8px; border: 1px solid var(--primary-light);">
                            <div style="font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 12px;">
                                üéØ Mengenentwicklung - Mathematische Modelle
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <button onclick="applyVolumeModel('linear')" style="padding: 8px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--gray-light)'"
                                        onmouseout="this.style.borderColor='var(--border)'; this.style.background='white'">
                                    üìä Linear<br>
                                    <span style="font-size: 9px; color: var(--gray);">Konstant</span>
                                </button>
                                
                                <button onclick="applyVolumeModel('s-curve')" style="padding: 8px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--gray-light)'"
                                        onmouseout="this.style.borderColor='var(--border)'; this.style.background='white'">
                                    üìà S-Kurve<br>
                                    <span style="font-size: 9px; color: var(--gray);">Marktreife</span>
                                </button>
                                
                                <button onclick="applyVolumeModel('exponential')" style="padding: 8px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--gray-light)'"
                                        onmouseout="this.style.borderColor='var(--border)'; this.style.background='white'">
                                    üöÄ Exponentiell<br>
                                    <span style="font-size: 9px; color: var(--gray);">Viral</span>
                                </button>
                                
                                <button onclick="applyVolumeModel('bell')" style="padding: 8px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--gray-light)'"
                                        onmouseout="this.style.borderColor='var(--border)'; this.style.background='white'">
                                    üîî Glockenkurve<br>
                                    <span style="font-size: 9px; color: var(--gray);">Trend</span>
                                </button>
                                
                                <button onclick="applyVolumeModel('plateau')" style="padding: 8px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--gray-light)'"
                                        onmouseout="this.style.borderColor='var(--border)'; this.style.background='white'">
                                    üìâ Plateau<br>
                                    <span style="font-size: 9px; color: var(--gray);">S√§ttigung</span>
                                </button>
                                
                                <button onclick="applyVolumeModel('hockey-stick')" style="padding: 8px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--gray-light)'"
                                        onmouseout="this.style.borderColor='var(--border)'; this.style.background='white'">
                                    üèí Hockey-Stick<br>
                                    <span style="font-size: 9px; color: var(--gray);">Breakout</span>
                                </button>
                                
                                <button onclick="applyVolumeModel('cyclical')" style="padding: 8px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--gray-light)'"
                                        onmouseout="this.style.borderColor='var(--border)'; this.style.background='white'">
                                    üîÑ Zyklisch<br>
                                    <span style="font-size: 9px; color: var(--gray);">Saison</span>
                                </button>
                                
                                <button onclick="applyVolumeModel('custom')" style="padding: 8px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--gray-light)'"
                                        onmouseout="this.style.borderColor='var(--border)'; this.style.background='white'">
                                    ‚úèÔ∏è Manuell<br>
                                    <span style="font-size: 9px; color: var(--gray);">Custom</span>
                                </button>
                            </div>
                            
                            <!-- Growth Metrics Display -->
                            <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; color: var(--primary);" id="metric-cagr">0%</div>
                                    <div style="font-size: 10px; color: var(--gray); text-transform: uppercase;">CAGR</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; color: var(--success);" id="metric-total-growth">0%</div>
                                    <div style="font-size: 10px; color: var(--gray); text-transform: uppercase;">Total Wachstum</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; color: var(--warning);" id="metric-max-yoy">0%</div>
                                    <div style="font-size: 10px; color: var(--gray); text-transform: uppercase;">Max YoY</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; color: var(--text);" id="metric-volatility">0%</div>
                                    <div style="font-size: 10px; color: var(--gray); text-transform: uppercase;">Volatilit√§t</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Jahres-Boxen mit YoY Anzeige -->
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px;">
                            <div style="background: var(--gray-light); border-radius: 8px; padding: 12px; border: 1px solid var(--border); position: relative;">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary); text-align: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                    2025
                                </div>
                                <div id="yoy-2025" style="position: absolute; top: 8px; right: 8px; font-size: 9px; font-weight: bold; color: var(--success);">-</div>
                                <input type="text" id="year-2025-volume" placeholder="Menge" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center; margin-bottom: 8px;"
                                       onchange="formatNumberInput(this); calculateYearOverYear(); updateCalculations();" onblur="formatNumberInput(this)">
                                <input type="text" id="year-2025-price" placeholder="Preis" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center;"
                                       onchange="formatDecimalInput(this); updateCalculations();" onblur="formatDecimalInput(this)">
                            </div>
                            
                            <div style="background: var(--gray-light); border-radius: 8px; padding: 12px; border: 1px solid var(--border); position: relative;">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary); text-align: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                    2026
                                </div>
                                <div id="yoy-2026" style="position: absolute; top: 8px; right: 8px; font-size: 9px; font-weight: bold; color: var(--success);">-</div>
                                <input type="text" id="year-2026-volume" placeholder="Menge" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center; margin-bottom: 8px;"
                                       onchange="formatNumberInput(this); calculateYearOverYear(); updateCalculations();" onblur="formatNumberInput(this)">
                                <input type="text" id="year-2026-price" placeholder="Preis" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center;"
                                       onchange="formatDecimalInput(this); updateCalculations();" onblur="formatDecimalInput(this)">
                            </div>
                            
                            <div style="background: var(--gray-light); border-radius: 8px; padding: 12px; border: 1px solid var(--border); position: relative;">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary); text-align: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                    2027
                                </div>
                                <div id="yoy-2027" style="position: absolute; top: 8px; right: 8px; font-size: 9px; font-weight: bold; color: var(--success);">-</div>
                                <input type="text" id="year-2027-volume" placeholder="Menge" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center; margin-bottom: 8px;"
                                       onchange="formatNumberInput(this); calculateYearOverYear(); updateCalculations();" onblur="formatNumberInput(this)">
                                <input type="text" id="year-2027-price" placeholder="Preis" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center;"
                                       onchange="formatDecimalInput(this); updateCalculations();" onblur="formatDecimalInput(this)">
                            </div>
                            
                            <div style="background: var(--gray-light); border-radius: 8px; padding: 12px; border: 1px solid var(--border); position: relative;">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary); text-align: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                    2028
                                </div>
                                <div id="yoy-2028" style="position: absolute; top: 8px; right: 8px; font-size: 9px; font-weight: bold; color: var(--success);">-</div>
                                <input type="text" id="year-2028-volume" placeholder="Menge" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center; margin-bottom: 8px;"
                                       onchange="formatNumberInput(this); calculateYearOverYear(); updateCalculations();" onblur="formatNumberInput(this)">
                                <input type="text" id="year-2028-price" placeholder="Preis" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center;"
                                       onchange="formatDecimalInput(this); updateCalculations();" onblur="formatDecimalInput(this)">
                            </div>
                            
                            <div style="background: var(--gray-light); border-radius: 8px; padding: 12px; border: 1px solid var(--border); position: relative;">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary); text-align: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                    2029
                                </div>
                                <div id="yoy-2029" style="position: absolute; top: 8px; right: 8px; font-size: 9px; font-weight: bold; color: var(--success);">-</div>
                                <input type="text" id="year-2029-volume" placeholder="Menge" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center; margin-bottom: 8px;"
                                       onchange="formatNumberInput(this); calculateYearOverYear(); updateCalculations();" onblur="formatNumberInput(this)">
                                <input type="text" id="year-2029-price" placeholder="Preis" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center;"
                                       onchange="formatDecimalInput(this); updateCalculations();" onblur="formatDecimalInput(this)">
                            </div>
                            
                            <div style="background: var(--gray-light); border-radius: 8px; padding: 12px; border: 1px solid var(--border); position: relative;">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary); text-align: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                    2030
                                </div>
                                <div id="yoy-2030" style="position: absolute; top: 8px; right: 8px; font-size: 9px; font-weight: bold; color: var(--success);">-</div>
                                <input type="text" id="year-2030-volume" placeholder="Menge" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center; margin-bottom: 8px;"
                                       onchange="formatNumberInput(this); calculateYearOverYear(); updateCalculations();" onblur="formatNumberInput(this)">
                                <input type="text" id="year-2030-price" placeholder="Preis" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; text-align: center;"
                                       onchange="formatDecimalInput(this); updateCalculations();" onblur="formatDecimalInput(this)">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="padding: 20px 0; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px;">
                        <button onclick="backToArtikelOverview()" style="padding: 10px 20px; border: 1px solid var(--border); background: var(--white); color: var(--gray); border-radius: 6px; font-size: 13px; cursor: pointer;">
                            Abbrechen
                        </button>
                        <button onclick="saveArtikelChanges()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer;">
                            üíæ Alle √Ñnderungen speichern
                        </button>
                    </div>
                </div>
            `;
        }
        
        function getProjekteTabContent() {
            return `
                <div style="padding: 20px; background: var(--gray-light); border-radius: 8px;">
                    <h3 style="margin-bottom: 20px;">Projekt-Kosten Planung</h3>
                    
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: var(--primary); color: white;">
                                <th style="padding: 12px; text-align: left;">Kategorie</th>
                                <th style="padding: 12px; text-align: center;">2024</th>
                                <th style="padding: 12px; text-align: center;">2025</th>
                                <th style="padding: 12px; text-align: center;">2026</th>
                                <th style="padding: 12px; text-align: center;">2027</th>
                                <th style="padding: 12px; text-align: center;">2028</th>
                                <th style="padding: 12px; text-align: center;">2029</th>
                                <th style="padding: 12px; text-align: center;">2030</th>
                                <th style="padding: 12px; text-align: center;">Gesamt</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border);">Personal</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">0</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">981</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">1.485</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">1.727</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">1.881</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">2.040</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">2.203</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center; font-weight: bold;">10.317</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border);">Material</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">0</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">83</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">105</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">128</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">142</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">156</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">171</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center; font-weight: bold;">785</td>
                            </tr>
                            <tr style="background: #fef3c7;">
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); font-weight: 600;">CAPEX</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center; font-weight: 600;">1.250</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">1.000</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">1.250</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">800</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">800</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">800</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">800</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center; font-weight: bold;">6.700</td>
                            </tr>
                            <tr style="background: var(--primary); color: white;">
                                <td style="padding: 12px; font-weight: bold;">Gesamt</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">1.570</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">2.544</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">3.200</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">2.895</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">2.943</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">3.116</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">3.294</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">19.562</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function getWirtschaftlichkeitTabContent() {
            return `
                <div style="padding: 20px; background: var(--gray-light); border-radius: 8px;">
                    <h3 style="margin-bottom: 20px;">üí∞ Wirtschaftlichkeitsberechnung & Amortisation</h3>
                    
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: var(--primary); color: white;">
                                <th style="padding: 12px; text-align: left;">Kennzahl</th>
                                <th style="padding: 12px; text-align: center;">2024</th>
                                <th style="padding: 12px; text-align: center;">2025</th>
                                <th style="padding: 12px; text-align: center;">2026</th>
                                <th style="padding: 12px; text-align: center;">2027</th>
                                <th style="padding: 12px; text-align: center;">2028</th>
                                <th style="padding: 12px; text-align: center;">2029</th>
                                <th style="padding: 12px; text-align: center;">2030</th>
                                <th style="padding: 12px; text-align: center;">Gesamt</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #dbeafe;">
                                <td style="padding: 12px;">üìà Umsatz (in T‚Ç¨)</td>
                                <td style="padding: 12px; text-align: center;">0</td>
                                <td style="padding: 12px; text-align: center;">2.900</td>
                                <td style="padding: 12px; text-align: center;">10.800</td>
                                <td style="padding: 12px; text-align: center;">24.200</td>
                                <td style="padding: 12px; text-align: center;">42.300</td>
                                <td style="padding: 12px; text-align: center;">47.000</td>
                                <td style="padding: 12px; text-align: center;">48.800</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">176.000</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px;">‚öôÔ∏è Herstellkosten (HK)</td>
                                <td style="padding: 12px; text-align: center;">0</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-1.900</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-7.200</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-15.800</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-27.500</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-30.600</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-31.800</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: var(--danger);">-114.800</td>
                            </tr>
                            <tr style="background: #f0f9ff; font-weight: 600;">
                                <td style="padding: 12px;">= DB2 (nach variablen Kosten)</td>
                                <td style="padding: 12px; text-align: center;">0</td>
                                <td style="padding: 12px; text-align: center;">855</td>
                                <td style="padding: 12px; text-align: center;">3.060</td>
                                <td style="padding: 12px; text-align: center;">7.190</td>
                                <td style="padding: 12px; text-align: center;">12.685</td>
                                <td style="padding: 12px; text-align: center;">14.050</td>
                                <td style="padding: 12px; text-align: center;">14.560</td>
                                <td style="padding: 12px; text-align: center; color: var(--success);">52.400</td>
                            </tr>
                            <tr style="background: #fef3c7;">
                                <td style="padding: 12px;">üèóÔ∏è Projektkosten</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-1.570</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-2.544</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-3.200</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-2.895</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-2.943</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-3.116</td>
                                <td style="padding: 12px; text-align: center; color: var(--danger);">-3.294</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: var(--danger);">-19.562</td>
                            </tr>
                            <tr style="background: var(--primary); color: white; font-weight: bold;">
                                <td style="padding: 12px;">= DB3 (nach Projektkosten)</td>
                                <td style="padding: 12px; text-align: center;">-1.570</td>
                                <td style="padding: 12px; text-align: center;">-1.689</td>
                                <td style="padding: 12px; text-align: center;">-140</td>
                                <td style="padding: 12px; text-align: center;">4.295</td>
                                <td style="padding: 12px; text-align: center;">9.742</td>
                                <td style="padding: 12px; text-align: center;">10.934</td>
                                <td style="padding: 12px; text-align: center;">11.266</td>
                                <td style="padding: 12px; text-align: center;">32.838</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: white; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: var(--success);">3.2 Jahre</div>
                            <div style="font-size: 12px; color: var(--gray);">Payback-Zeit</div>
                            <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">Break-Even in Q2/2027</div>
                        </div>
                        
                        <div style="background: white; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: var(--primary);">32.8M‚Ç¨</div>
                            <div style="font-size: 12px; color: var(--gray);">NPV (7 Jahre)</div>
                            <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">ohne Diskontierung</div>
                        </div>
                        
                        <div style="background: white; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: var(--warning);">168%</div>
                            <div style="font-size: 12px; color: var(--gray);">ROI</div>
                            <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">32.8M‚Ç¨ / 19.6M‚Ç¨</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 16px; background: #f0fdf4; border-left: 4px solid var(--success); border-radius: 8px;">
                        <div style="font-weight: bold; color: var(--success); margin-bottom: 8px;">‚úÖ BUSINESS CASE POSITIV</div>
                        <div style="font-size: 13px; color: var(--text);">
                            <strong>Empfehlung:</strong> Freigabe empfohlen.<br>
                            <strong>Kritisch:</strong> 3.4M‚Ç¨ Vorfinanzierung bis Break-Even.<br>
                            <strong>Risiko:</strong> Marktpenetration muss planm√§√üig erfolgen.
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadArtikelData() {
            if (!cfoDashboard.currentArtikel) return;
            
            const artikelData = {
                'crimp': {
                    name: 'Crimpautomat',
                    type: 'neu',
                    release: '2024-12',
                    umsatzerhaltung: 'nein',
                    assumptions: 'Innovation durch neue Linie',
                    strategy: 'inflation',
                    hkProStueck: 3.00,
                    years: {
                        2025: { volume: 200, price: 5.00 },
                        2026: { volume: 1000, price: 5.15 },
                        2027: { volume: 2500, price: 5.30 },
                        2028: { volume: 5000, price: 5.46 },
                        2029: { volume: 5000, price: 5.62 },
                        2030: { volume: 5000, price: 5.79 }
                    }
                },
                'komax': {
                    name: 'Mini-Komax ohne CORE', 
                    type: 'neu',
                    release: '2024-12',
                    umsatzerhaltung: 'nein',
                    assumptions: 'Premium-Segment erschlie√üen',
                    strategy: 'conservative',
                    hkProStueck: 670.00,
                    years: {
                        2025: { volume: 6, price: 1000.00 },
                        2026: { volume: 14, price: 1020.00 },
                        2027: { volume: 27, price: 1040.40 },
                        2028: { volume: 42, price: 1061.21 },
                        2029: { volume: 53, price: 1082.43 },
                        2030: { volume: 53, price: 1104.08 }
                    }
                },
                'digital': {
                    name: 'Digital Shopfloor Backend',
                    type: 'cross',
                    release: '2025-06',
                    umsatzerhaltung: 'ja',
                    assumptions: '40% Aufteilung mit Best√ºckung',
                    strategy: 'fixed',
                    hkProStueck: 192.00,
                    years: {
                        2025: { volume: 50, price: 480.00 },
                        2026: { volume: 150, price: 480.00 },
                        2027: { volume: 200, price: 480.00 },
                        2028: { volume: 250, price: 480.00 },
                        2029: { volume: 250, price: 480.00 },
                        2030: { volume: 200, price: 480.00 }
                    }
                }
            };
            
            const data = artikelData[cfoDashboard.currentArtikel];
            cfoDashboard.currentArtikelData = data; // Store for later use
            
            if (data) {
                // Set basic fields
                if (document.getElementById('edit-name')) {
                    document.getElementById('edit-name').value = data.name;
                    document.getElementById('edit-type').value = data.type;
                    document.getElementById('edit-release').value = data.release;
                    document.getElementById('edit-umsatzerhaltung').value = data.umsatzerhaltung;
                    document.getElementById('edit-assumptions').value = data.assumptions;
                    document.getElementById('edit-strategy').value = data.strategy;
                    
                    // Load year data with formatting
                    for (let year = 2025; year <= 2030; year++) {
                        const volumeInput = document.getElementById(`year-${year}-volume`);
                        const priceInput = document.getElementById(`year-${year}-price`);
                        
                        if (volumeInput && data.years[year]) {
                            volumeInput.value = formatThousands(data.years[year].volume);
                        }
                        if (priceInput && data.years[year]) {
                            priceInput.value = formatDecimal(data.years[year].price);
                        }
                    }
                    
                    // Load financial parameters for selected year (default 2027)
                    loadYearData('2027');
                    
                    // Calculate totals
                    updateTotals();
                }
            }
        }
        
        // Load financial data for specific year
        function loadYearData(year) {
            if (!cfoDashboard.currentArtikelData) return;
            
            const data = cfoDashboard.currentArtikelData;
            const yearData = data.years[year];
            
            if (yearData) {
                // Update parameter fields
                if (document.getElementById('param-menge')) {
                    document.getElementById('param-menge').value = formatThousands(yearData.volume);
                    document.getElementById('param-preis').value = formatDecimal(yearData.price);
                    
                    // Set HK pro St√ºck
                    document.getElementById('param-hk-stueck').value = formatDecimal(data.hkProStueck);
                    
                    // Calculate financials
                    calculateFinancials();
                }
                
                // Update year data in Jahres-Entwicklung section
                const volumeInput = document.getElementById(`year-${year}-volume`);
                const priceInput = document.getElementById(`year-${year}-price`);
                if (volumeInput) volumeInput.value = formatThousands(yearData.volume);
                if (priceInput) priceInput.value = formatDecimal(yearData.price);
            }
        }
        
        // Update HK pro St√ºck in data
        function updateHKProStueck() {
            const hkProStueck = parseFormattedNumber(document.getElementById('param-hk-stueck')?.value) || 0;
            if (cfoDashboard.currentArtikelData) {
                cfoDashboard.currentArtikelData.hkProStueck = hkProStueck;
            }
        }
        
        // Calculate financial metrics
        function calculateFinancials() {
            const menge = parseFormattedNumber(document.getElementById('param-menge')?.value) || 0;
            const preis = parseFormattedNumber(document.getElementById('param-preis')?.value) || 0;
            const hkProStueck = parseFormattedNumber(document.getElementById('param-hk-stueck')?.value) || 
                                cfoDashboard.currentArtikelData?.hkProStueck || 0;
            
            // Example calculation:
            // Menge: 200 St√ºck
            // Preis: 5.000‚Ç¨/St√ºck  
            // Umsatz: 200 √ó 5.000 = 1.000.000‚Ç¨
            // HK pro St√ºck: 3.000‚Ç¨
            // HK Gesamt: 200 √ó 3.000 = 600.000‚Ç¨
            // DB2 absolut: 1.000.000 - 600.000 = 400.000‚Ç¨
            // DB2 %: 400.000 / 1.000.000 = 40%
            
            // Calculate Umsatz
            const umsatz = menge * preis;
            
            // Calculate HK Gesamt
            const hkGesamt = menge * hkProStueck;
            
            // Calculate DB2 absolut
            const db2Absolut = umsatz - hkGesamt;
            
            // Calculate DB2 in %
            const db2Percent = umsatz > 0 ? (db2Absolut / umsatz * 100) : 0;
            
            // Update displays
            if (document.getElementById('param-umsatz')) {
                document.getElementById('param-umsatz').textContent = formatDecimal(umsatz) + '‚Ç¨';
            }
            
            if (document.getElementById('param-hk-gesamt')) {
                document.getElementById('param-hk-gesamt').textContent = formatDecimal(hkGesamt) + '‚Ç¨';
            }
            
            if (document.getElementById('param-db2')) {
                document.getElementById('param-db2').textContent = db2Percent.toFixed(1) + '%';
                // Color coding
                document.getElementById('param-db2').style.color = 
                    db2Percent >= 35 ? 'var(--success)' : 
                    db2Percent >= 25 ? 'var(--primary)' : 
                    'var(--danger)';
                
                // Add tooltip with calculation details
                document.getElementById('param-db2').title = 
                    `Berechnung DB2:\n` +
                    `Umsatz: ${formatDecimal(umsatz)}‚Ç¨ (${formatThousands(menge)} √ó ${formatDecimal(preis)}‚Ç¨)\n` +
                    `HK Gesamt: ${formatDecimal(hkGesamt)}‚Ç¨ (${formatThousands(menge)} √ó ${formatDecimal(hkProStueck)}‚Ç¨)\n` +
                    `DB2 absolut: ${formatDecimal(db2Absolut)}‚Ç¨\n` +
                    `DB2 %: ${formatDecimal(db2Absolut)}‚Ç¨ / ${formatDecimal(umsatz)}‚Ç¨ = ${db2Percent.toFixed(1)}%`;
            }
            
            // Update year data when changed
            const selectedYear = document.getElementById('year-selector')?.value;
            if (selectedYear) {
                const volumeInput = document.getElementById(`year-${selectedYear}-volume`);
                const priceInput = document.getElementById(`year-${selectedYear}-price`);
                if (volumeInput) volumeInput.value = formatThousands(menge);
                if (priceInput) priceInput.value = formatDecimal(preis);
            }
            
            // Update totals
            updateTotals();
            
            // KI Analysis mit korrekten Werten
            if (db2Percent < 25 && db2Percent > 0) {
                cfoDashboard.aiController.addAIMessage({
                    level: 'warning',
                    title: '‚ö†Ô∏è DB2-Marge kritisch',
                    text: `Marge ${db2Percent.toFixed(1)}% im Jahr ${selectedYear} unter Minimum!
                           Berechnung: (${formatDecimal(umsatz)}‚Ç¨ - ${formatDecimal(hkGesamt)}‚Ç¨) / ${formatDecimal(umsatz)}‚Ç¨`,
                    recommendation: `Bei HK/St√ºck von ${formatDecimal(hkProStueck)}‚Ç¨ sollte der Preis mindestens ${formatDecimal(hkProStueck * 1.33)}‚Ç¨ betragen f√ºr 25% Marge.`,
                    actions: [
                        `Preis auf ${formatDecimal(hkProStueck * 1.43)}‚Ç¨ f√ºr 30% Marge`,
                        `Preis auf ${formatDecimal(hkProStueck * 1.54)}‚Ç¨ f√ºr 35% Marge`,
                        `Oder HK/St√ºck um ${formatDecimal(hkProStueck * 0.2)}‚Ç¨ senken`
                    ],
                    timestamp: 'Finanz-Analyse'
                });
            } else if (db2Percent >= 50) {
                cfoDashboard.aiController.addAIMessage({
                    level: 'success',
                    title: '‚úÖ Starke DB2-Marge',
                    text: `Exzellente Marge von ${db2Percent.toFixed(1)}% erreicht!
                           DB2 absolut: ${formatDecimal(db2Absolut)}‚Ç¨ bei ${formatThousands(menge)} St√ºck`,
                    recommendation: 'Premium-Positionierung erfolgreich. Volumen-Skalierung pr√ºfen ohne Preiserosion.',
                    timestamp: 'Finanz-Analyse'
                });
            }
        }
        
        // Update total calculations
        function updateTotals() {
            if (!cfoDashboard.currentArtikelData) return;
            
            let totalRevenue = 0;
            let totalDB2 = 0;
            let peakVolume = 0;
            let yearsWithData = 0;
            
            const data = cfoDashboard.currentArtikelData;
            
            // Calculate totals from all years
            for (let year = 2025; year <= 2030; year++) {
                const volumeInput = document.getElementById(`year-${year}-volume`);
                const priceInput = document.getElementById(`year-${year}-price`);
                
                if (volumeInput && priceInput) {
                    const volume = parseFormattedNumber(volumeInput.value) || 0;
                    const price = parseFormattedNumber(priceInput.value) || 0;
                    
                    if (volume > 0 && price > 0) {
                        const yearRevenue = volume * price;
                        const yearHK = volume * data.hkProStueck;
                        const yearDB2 = ((yearRevenue - yearHK) / yearRevenue * 100);
                        
                        totalRevenue += yearRevenue;
                        totalDB2 += yearDB2;
                        yearsWithData++;
                        
                        if (volume > peakVolume) {
                            peakVolume = volume;
                        }
                    }
                }
            }
            
            // Update display
            if (document.getElementById('total-revenue')) {
                if (totalRevenue >= 1000000) {
                    document.getElementById('total-revenue').textContent = formatDecimal(totalRevenue / 1000000) + 'M‚Ç¨';
                } else if (totalRevenue >= 1000) {
                    document.getElementById('total-revenue').textContent = formatDecimal(totalRevenue / 1000) + 'k‚Ç¨';
                } else {
                    document.getElementById('total-revenue').textContent = formatDecimal(totalRevenue) + '‚Ç¨';
                }
            }
            
            if (document.getElementById('avg-margin')) {
                const avgMargin = yearsWithData > 0 ? (totalDB2 / yearsWithData) : 0;
                document.getElementById('avg-margin').textContent = avgMargin.toFixed(1) + '%';
                document.getElementById('avg-margin').style.color = 
                    avgMargin >= 35 ? 'var(--success)' : 
                    avgMargin >= 25 ? 'var(--primary)' : 
                    'var(--danger)';
            }
            
            if (document.getElementById('peak-volume')) {
                document.getElementById('peak-volume').textContent = formatThousands(peakVolume);
            }
        }
        
        // Number formatting functions
        function formatThousands(num) {
            if (!num && num !== 0) return '';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        function formatDecimal(num) {
            if (!num && num !== 0) return '';
            return num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        function parseFormattedNumber(str) {
            if (!str) return 0;
            return parseFloat(str.toString().replace(/\./g, '').replace(',', '.')) || 0;
        }
        
        function formatNumberInput(input) {
            const value = parseFormattedNumber(input.value);
            if (!isNaN(value)) {
                input.value = formatThousands(Math.round(value));
            }
        }
        
        function formatDecimalInput(input) {
            const value = parseFormattedNumber(input.value);
            if (!isNaN(value)) {
                input.value = formatDecimal(value);
            }
        }
        
        function updateCalculations() {
            // This function is now primarily replaced by calculateFinancials and updateTotals
            // but kept for backward compatibility
            calculateYearOverYear();
            updateTotals();
        }
        
        // Apply mathematical volume models with automatic calculation
        function applyVolumeModel(modelType) {
            // Get start volume from current first year or param-menge
            let startVolume = parseFormattedNumber(document.getElementById('year-2025-volume')?.value) || 
                             parseFormattedNumber(document.getElementById('param-menge')?.value) || 200;
            
            // Get peak volume from peak-volume display or calculate
            let peakVolume = parseFormattedNumber(document.getElementById('peak-volume')?.textContent) || 5000;
            
            // If peak is less than start, auto-calculate reasonable peak
            if (peakVolume <= startVolume) {
                peakVolume = startVolume * 10; // Default 10x growth potential
            }
            
            let volumes = [];
            const years = [2025, 2026, 2027, 2028, 2029, 2030];
            
            switch(modelType) {
                case 'linear':
                    const increment = (peakVolume - startVolume) / 5;
                    for (let i = 0; i < 6; i++) {
                        volumes.push(Math.round(startVolume + (increment * i)));
                    }
                    break;
                    
                case 's-curve':
                    for (let i = 0; i < 6; i++) {
                        const t = i / 5;
                        const sigmoid = 1 / (1 + Math.exp(-10 * (t - 0.5)));
                        volumes.push(Math.round(startVolume + (peakVolume - startVolume) * sigmoid));
                    }
                    break;
                    
                case 'exponential':
                    const expGrowthRate = Math.pow(peakVolume / startVolume, 1/5);
                    for (let i = 0; i < 6; i++) {
                        const vol = startVolume * Math.pow(expGrowthRate, i);
                        volumes.push(Math.min(Math.round(vol), peakVolume * 2)); // Cap at 2x peak
                    }
                    break;
                    
                case 'bell':
                    const peakYear = 2.5; // Peak between year 3 and 4
                    for (let i = 0; i < 6; i++) {
                        const gaussian = Math.exp(-Math.pow(i - peakYear, 2) / 2);
                        volumes.push(Math.round(startVolume + (peakVolume - startVolume) * gaussian));
                    }
                    break;
                    
                case 'plateau':
                    for (let i = 0; i < 6; i++) {
                        if (i < 3) {
                            volumes.push(Math.round(startVolume + (peakVolume - startVolume) * (i / 2.5)));
                        } else {
                            volumes.push(peakVolume);
                        }
                    }
                    break;
                    
                case 'hockey-stick':
                    // Slow start for 2-3 years, then explosive
                    for (let i = 0; i < 6; i++) {
                        if (i < 2) {
                            // Very slow growth first 2 years
                            volumes.push(Math.round(startVolume * (1 + i * 0.1)));
                        } else {
                            // Explosive growth after year 2
                            const explosiveGrowth = startVolume * 1.2 * Math.pow(2.5, i - 2);
                            volumes.push(Math.min(Math.round(explosiveGrowth), peakVolume));
                        }
                    }
                    break;
                    
                case 'cyclical':
                    for (let i = 0; i < 6; i++) {
                        const cycle = Math.sin(i * Math.PI / 2) * 0.3 + 0.7;
                        volumes.push(Math.round(startVolume + (peakVolume - startVolume) * (i / 5) * cycle));
                    }
                    break;
                    
                case 'custom':
                    // Don't auto-fill
                    return;
            }
            
            // Apply volumes to year inputs
            years.forEach((year, index) => {
                const volumeInput = document.getElementById(`year-${year}-volume`);
                if (volumeInput && volumes[index] !== undefined) {
                    volumeInput.value = formatThousands(volumes[index]);
                }
            });
            
            // Apply price strategy
            applyPriceStrategy();
            
            // Calculate YoY and metrics
            calculateYearOverYear();
            
            // Analyze and provide KI feedback
            analyzeGrowthPattern(volumes, modelType);
        }
        
        // Calculate Year-over-Year growth
        function calculateYearOverYear() {
            const years = [2025, 2026, 2027, 2028, 2029, 2030];
            let volumes = [];
            let yoyGrowths = [];
            
            // Collect volumes
            years.forEach(year => {
                const volume = parseFormattedNumber(document.getElementById(`year-${year}-volume`)?.value) || 0;
                volumes.push(volume);
            });
            
            // Calculate YoY for each year
            for (let i = 0; i < volumes.length; i++) {
                const yoyElement = document.getElementById(`yoy-${years[i]}`);
                if (yoyElement) {
                    if (i === 0) {
                        yoyElement.textContent = 'Start';
                        yoyElement.style.color = 'var(--gray)';
                    } else if (volumes[i] > 0 && volumes[i-1] > 0) {
                        const yoyGrowth = ((volumes[i] - volumes[i-1]) / volumes[i-1] * 100);
                        yoyGrowths.push(yoyGrowth);
                        yoyElement.textContent = (yoyGrowth >= 0 ? '+' : '') + yoyGrowth.toFixed(0) + '%';
                        
                        // Color coding based on growth rate
                        if (yoyGrowth > 100) {
                            yoyElement.style.color = 'var(--danger)'; // Red for unrealistic
                        } else if (yoyGrowth > 50) {
                            yoyElement.style.color = 'var(--warning)'; // Orange for aggressive
                        } else if (yoyGrowth > 0) {
                            yoyElement.style.color = 'var(--success)'; // Green for positive
                        } else {
                            yoyElement.style.color = 'var(--danger)'; // Red for negative
                        }
                    } else {
                        yoyElement.textContent = '-';
                        yoyElement.style.color = 'var(--gray)';
                    }
                }
            }
            
            // Calculate and display metrics
            if (volumes[0] > 0 && volumes[5] > 0) {
                // CAGR
                const cagr = (Math.pow(volumes[5] / volumes[0], 1/5) - 1) * 100;
                document.getElementById('metric-cagr').textContent = cagr.toFixed(1) + '%';
                
                // Total Growth
                const totalGrowth = ((volumes[5] - volumes[0]) / volumes[0] * 100);
                document.getElementById('metric-total-growth').textContent = totalGrowth.toFixed(0) + '%';
                
                // Max YoY
                const maxYoy = yoyGrowths.length > 0 ? Math.max(...yoyGrowths) : 0;
                document.getElementById('metric-max-yoy').textContent = maxYoy.toFixed(0) + '%';
                
                // Volatility
                const avgVolume = volumes.reduce((a,b) => a+b, 0) / volumes.length;
                const maxVolume = Math.max(...volumes);
                const minVolume = Math.min(...volumes.filter(v => v > 0));
                const volatility = avgVolume > 0 ? ((maxVolume - minVolume) / avgVolume * 100) : 0;
                document.getElementById('metric-volatility').textContent = volatility.toFixed(0) + '%';
                
                // Update color coding for metrics
                document.getElementById('metric-cagr').style.color = 
                    cagr > 50 ? 'var(--danger)' : 
                    cagr > 30 ? 'var(--warning)' : 
                    cagr > 0 ? 'var(--success)' : 'var(--gray)';
                    
                document.getElementById('metric-max-yoy').style.color = 
                    maxYoy > 100 ? 'var(--danger)' : 
                    maxYoy > 50 ? 'var(--warning)' : 'var(--success)';
            }
            
            // Update totals
            updateTotals();
        }
        
        // Analyze growth pattern and provide KI feedback
        function analyzeGrowthPattern(volumes, modelType) {
            const startVolume = volumes[0];
            const endVolume = volumes[5];
            const maxVolume = Math.max(...volumes);
            
            // Calculate key metrics
            const cagr = (Math.pow(endVolume / startVolume, 1/5) - 1) * 100;
            const totalGrowth = ((endVolume - startVolume) / startVolume * 100);
            
            // Find max YoY growth
            let maxYoyGrowth = 0;
            for (let i = 1; i < volumes.length; i++) {
                if (volumes[i-1] > 0) {
                    const yoy = ((volumes[i] - volumes[i-1]) / volumes[i-1] * 100);
                    if (yoy > maxYoyGrowth) maxYoyGrowth = yoy;
                }
            }
            
            // Determine risk level and message
            let level = 'info';
            let title = '';
            let text = '';
            let recommendation = '';
            let actions = [];
            
            if (maxYoyGrowth > 200) {
                level = 'danger';
                title = 'üö® Unrealistisches Wachstum!';
                text = `${modelType} Modell mit ${maxYoyGrowth.toFixed(0)}% YoY-Peak ist extrem unrealistisch!`;
                recommendation = 'Wachstumsraten √ºber 200% sind nur bei viralen Produkten in neuen M√§rkten m√∂glich.';
                actions = [
                    'Reduzieren Sie Peak-Menge oder w√§hlen Sie konservativeres Modell',
                    'Pr√ºfen Sie Marktgr√∂√üe und Wettbewerb',
                    'Benchmarken Sie mit vergleichbaren Produkten'
                ];
            } else if (maxYoyGrowth > 100) {
                level = 'warning';
                title = '‚ö†Ô∏è Sehr ambitioniertes Wachstum';
                text = `${modelType} mit CAGR ${cagr.toFixed(1)}% und max. ${maxYoyGrowth.toFixed(0)}% YoY ist sehr optimistisch.`;
                recommendation = 'Wachstumsraten √ºber 100% ben√∂tigen au√üergew√∂hnliche Marktbedingungen.';
                actions = [
                    `Produktionskapazit√§t f√ºr ${formatThousands(maxVolume)} St√ºck sicherstellen`,
                    'Marketing-Budget f√ºr aggressive Expansion planen',
                    'Risiko-Szenario mit 50% der Mengen rechnen'
                ];
            } else if (cagr > 30) {
                level = 'success';
                title = '‚úÖ Ambitioniert aber machbar';
                text = `${modelType} Modell mit CAGR ${cagr.toFixed(1)}% ist herausfordernd aber realistisch.`;
                recommendation = 'Gute Balance zwischen Wachstum und Machbarkeit.';
                actions = [
                    `Stufenweise Kapazit√§tserweiterung planen`,
                    `Working Capital f√ºr Wachstum sichern`,
                    `Meilensteine f√ºr Modell-Validierung setzen`
                ];
            } else if (cagr > 10) {
                level = 'info';
                title = 'üìä Moderates Wachstum';
                text = `${modelType} mit CAGR ${cagr.toFixed(1)}% ist konservativ und gut planbar.`;
                recommendation = 'Stabiles Wachstum mit geringem Risiko.';
            } else {
                level = 'warning';
                title = 'üìâ Schwaches Wachstum';
                text = `CAGR nur ${cagr.toFixed(1)}% - Potenzial m√∂glicherweise untersch√§tzt?`;
                recommendation = 'Pr√ºfen Sie ob aggressivere Markterschlie√üung m√∂glich ist.';
            }
            
            // Add specific model insights
            const modelInsights = {
                'hockey-stick': 'Typisch f√ºr Plattform-Gesch√§fte nach Netzwerkeffekten.',
                's-curve': 'Klassischer Produktlebenszyklus mit Marktdurchdringung.',
                'exponential': 'Nur realistisch bei disruptiven Innovationen oder viralen Produkten.',
                'linear': 'Einfachstes Modell, ignoriert Marktdynamik.',
                'bell': 'Geeignet f√ºr Trend-Produkte mit begrenztem Lebenszyklus.',
                'plateau': 'Ber√ºcksichtigt Markts√§ttigung - realistisch f√ºr begrenzte M√§rkte.',
                'cyclical': 'Gut f√ºr saisonale oder konjunkturabh√§ngige Produkte.'
            };
            
            if (modelInsights[modelType]) {
                text += ' ' + modelInsights[modelType];
            }
            
            // Send KI message
            cfoDashboard.aiController.addAIMessage({
                level: level,
                title: title,
                text: text,
                recommendation: recommendation,
                actions: actions.length > 0 ? actions : undefined,
                timestamp: 'Wachstums-Analyse'
            });
        }
        
        function saveArtikelChanges() {
            cfoDashboard.aiController.addAIMessage({
                level: 'success',
                title: '‚úÖ √Ñnderungen gespeichert',
                text: 'Artikel-Parameter aktualisiert. Dashboard-Charts werden neu berechnet.',
                recommendation: 'Pr√ºfen Sie die Auswirkungen auf NPV und Payback im Dashboard.',
                timestamp: 'Speicherung'
            });
        }
        
        function addNewArtikel() {
            cfoDashboard.aiController.addAIMessage({
                level: 'info',
                title: '‚ûï Neuer Artikel',
                text: 'Artikel-Erstellung gestartet. Definieren Sie Produkt-Parameter f√ºr Business Case Erweiterung.',
                recommendation: 'Neue Artikel sollten mind. 30% DB2-Marge f√ºr Portfolio-Aufnahme erreichen.',
                timestamp: 'Artikel-Creation'
            });
        }
        
        // KI Agent Functions
        function analyzeContext() {
            const input = document.getElementById('context-input').value.trim();
            if (!input) {
                alert('Bitte geben Sie eine Business Case Beschreibung ein.');
                return;
            }
            
            // Show process animation
            document.getElementById('analysis-process').style.display = 'block';
            document.getElementById('context-result').style.display = 'none';
            
            const steps = document.querySelectorAll('.analysis-step');
            steps.forEach((step, index) => {
                setTimeout(() => {
                    const icon = step.querySelector('.step-icon');
                    const text = step.querySelector('.step-text');
                    
                    // Simulate analysis progress
                    icon.textContent = '‚ö°';
                    icon.style.color = '#f59e0b';
                    
                    setTimeout(() => {
                        icon.textContent = '‚úÖ';
                        icon.style.color = '#10b981';
                        
                        if (index === steps.length - 1) {
                            // Analysis complete
                            setTimeout(() => showAnalysisResult(input), 500);
                        }
                    }, 800);
                }, 1500 * (index + 1));
            });
        }
        
        function showAnalysisResult(input) {
            const resultDiv = document.getElementById('context-result');
            
            // Simulated AI analysis based on keywords
            let analysis = analyzeBusinessCase(input);
            
            resultDiv.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #166534;">‚úÖ Kontext erfolgreich analysiert</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Asset-Typ</div>
                            <div style="font-size: 16px; font-weight: 600; color: #1e293b;">${analysis.assetType}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Branche</div>
                            <div style="font-size: 16px; font-weight: 600; color: #1e293b;">${analysis.industry}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Gesch√§ftsmodell</div>
                            <div style="font-size: 16px; font-weight: 600; color: #1e293b;">${analysis.businessModel}</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #1e40af;">üìä Empfohlene KPIs f√ºr Header</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        ${analysis.recommendedKPIs.map(kpi => `
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-weight: 600; color: #3b82f6;">${kpi}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #92400e;">‚ö†Ô∏è Kritische Validierungen</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${analysis.validations.map(val => `<li style="margin-bottom: 8px;">${val}</li>`).join('')}
                    </ul>
                </div>
                
                <button onclick="applyContextToCase()" style="margin-top: 20px; padding: 12px 30px; background: linear-gradient(135deg, #10b981, #34d399); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    ‚úÖ Kontext auf Business Case anwenden
                </button>
            `;
            
            resultDiv.style.display = 'block';
            document.getElementById('analysis-process').style.display = 'none';
            
            // Add AI message
            cfoDashboard.aiController.addAIMessage({
                level: 'success',
                title: 'üß† KI-Kontext erkannt',
                text: `${analysis.assetType} im Bereich ${analysis.industry} mit ${analysis.businessModel} Modell identifiziert.`,
                recommendation: `Kritische KPIs: ${analysis.recommendedKPIs.slice(0, 3).join(', ')}`,
                timestamp: 'Kontext-Analyse'
            });
        }
        
        function analyzeBusinessCase(input) {
            const lowercaseInput = input.toLowerCase();
            
            // Asset Type Detection
            let assetType = 'Unbekannt';
            if (lowercaseInput.includes('software') || lowercaseInput.includes('saas') || lowercaseInput.includes('cloud') || lowercaseInput.includes('app')) {
                assetType = 'üì± Software';
            } else if (lowercaseInput.includes('hardware') || lowercaseInput.includes('ger√§t') || lowercaseInput.includes('maschine') || lowercaseInput.includes('komponente') || lowercaseInput.includes('schaltschrank')) {
                assetType = 'üè≠ Hardware';
            } else if (lowercaseInput.includes('beratung') || lowercaseInput.includes('service') || lowercaseInput.includes('dienstleistung') || lowercaseInput.includes('consulting')) {
                assetType = 'üíº Service';
            }
            
            // Industry Detection
            let industry = 'Allgemein';
            if (lowercaseInput.includes('automotive') || lowercaseInput.includes('auto')) {
                industry = 'üöó Automotive';
            } else if (lowercaseInput.includes('pharma') || lowercaseInput.includes('medizin')) {
                industry = 'üíä Pharma';
            } else if (lowercaseInput.includes('maschinenbau') || lowercaseInput.includes('industrie')) {
                industry = 'üèóÔ∏è Maschinenbau';
            } else if (lowercaseInput.includes('mittelstand') || lowercaseInput.includes('kmu')) {
                industry = 'üè¢ Mittelstand';
            }
            
            // Business Model Detection
            let businessModel = 'Einmalverkauf';
            if (lowercaseInput.includes('subscription') || lowercaseInput.includes('abo') || lowercaseInput.includes('recurring')) {
                businessModel = 'üîÑ Subscription';
            } else if (lowercaseInput.includes('lizenz') || lowercaseInput.includes('license')) {
                businessModel = 'üìú Lizenzmodell';
            } else if (lowercaseInput.includes('leasing')) {
                businessModel = 'üìÖ Leasing';
            }
            
            // Context-specific KPIs
            let recommendedKPIs = [];
            let validations = [];
            
            if (assetType === 'üì± Software') {
                recommendedKPIs = ['ARR (Annual Recurring Revenue)', 'CAC/LTV Ratio', 'Monthly Churn Rate', 'Net Revenue Retention', 'Gross Margin', 'Rule of 40'];
                validations = ['Herstellkosten sollten unter 20% liegen', 'Churn Rate muss unter 10% p.a. bleiben', 'CAC Payback Period < 18 Monate'];
            } else if (assetType === 'üè≠ Hardware') {
                recommendedKPIs = ['NPV (Net Present Value)', 'ROCE (Return on Capital)', 'Break-Even Volume', 'Working Capital Requirement', 'Capacity Utilization', 'PPM Rate'];
                validations = ['Working Capital Bedarf einplanen', 'Anlaufkosten ber√ºcksichtigen', 'Produktionskapazit√§t pr√ºfen'];
            } else {
                recommendedKPIs = ['Utilization Rate', 'Average Day Rate', 'Project Pipeline Value', 'FTE Productivity', 'Gross Margin', 'Client Retention'];
                validations = ['Auslastung muss √ºber 75% liegen', 'Tagess√§tze marktkonform?', 'Skalierung nur mit mehr Personal'];
            }
            
            return {
                assetType,
                industry,
                businessModel,
                recommendedKPIs,
                validations
            };
        }
        
        function applyContextToCase() {
            // Update header KPIs based on context
            alert('Kontext wird auf Business Case angewendet. KPIs im Header werden angepasst.');
            
            // Switch back to dashboard
            switchTab('dashboard');
            
            cfoDashboard.aiController.addAIMessage({
                level: 'success',
                title: '‚úÖ Kontext angewendet',
                text: 'Business Case wurde auf den erkannten Kontext optimiert.',
                recommendation: 'Dashboard zeigt nun relevante KPIs f√ºr Ihren spezifischen Case.',
                timestamp: 'Kontext-Anwendung'
            });
        }
        
        function switchPlaybook(section) {
            // Hide all sections
            document.querySelectorAll('.playbook-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.playbook-tab-btn').forEach(btn => {
                btn.style.background = 'transparent';
            });
            
            // Show selected section
            document.getElementById(`playbook-${section}`).style.display = 'block';
            event.target.style.background = 'white';
        }
        
        function editAssetType(type) {
            alert(`Asset-Typ "${type}" Konfiguration √∂ffnen...`);
        }
        
        function addValidationRule() {
            alert('Neue Validierungsregel hinzuf√ºgen...');
        }
        
        function loadTestScenario() {
            const scenario = document.getElementById('test-scenario').value;
            const testInput = document.getElementById('test-input');
            
            const scenarios = {
                'saas': 'Neue B2B SaaS L√∂sung f√ºr Customer Relationship Management im Mittelstand',
                'hardware-auto': 'Schaltschrankkomponenten f√ºr Automotive Tier-1 Zulieferer',
                'consulting': 'IT-Beratungsdienstleistung f√ºr digitale Transformation in der Pharma-Industrie'
            };
            
            if (scenarios[scenario]) {
                testInput.value = scenarios[scenario];
            }
        }
        
        function runAITest() {
            const input = document.getElementById('test-input').value || document.getElementById('test-scenario').value;
            if (!input) {
                alert('Bitte w√§hlen Sie ein Szenario oder geben Sie eine Beschreibung ein.');
                return;
            }
            
            const output = document.getElementById('test-output');
            output.style.display = 'block';
            
            // Simulate AI analysis
            const analysis = analyzeBusinessCase(input);
            
            output.innerHTML = `
                <div style="color: #10b981; margin-bottom: 10px;">> Analysiere: "${input}"</div>
                <div style="color: #fbbf24;">
                    > Asset-Typ erkannt: ${analysis.assetType}<br>
                    > Branche identifiziert: ${analysis.industry}<br>
                    > Gesch√§ftsmodell: ${analysis.businessModel}<br>
                    <br>
                    > Empfohlene KPIs:<br>
                    ${analysis.recommendedKPIs.map(kpi => `  - ${kpi}`).join('<br>')}<br>
                    <br>
                    > Validierungen:<br>
                    ${analysis.validations.map(val => `  ‚ö†Ô∏è ${val}`).join('<br>')}<br>
                    <br>
                    <span style="color: #10b981;">> Test erfolgreich abgeschlossen ‚úì</span>
                </div>
            `;
        }

        function aiAction(action) {
            console.log('AI Action triggered:', action);
            
            switch(action) {
                case 'deep-analysis':
                    cfoDashboard.aiController.addAIMessage({
                        level: 'info',
                        title: 'üîç Deep Dive Analyse gestartet',
                        text: 'Analysiere 1.400+ Finance-Patterns und Industrie-Benchmarks...',
                        timestamp: 'Analyse l√§uft'
                    });
                    
                    setTimeout(() => {
                        const patterns = cfoDashboard.aiController.runPatternAnalysis();
                        const benchmarks = cfoDashboard.aiController.compareToBenchmarks();
                        
                        cfoDashboard.aiController.addAIMessage({
                            level: patterns.length > 2 ? 'warning' : 'success',
                            title: 'üìä Deep Dive abgeschlossen',
                            text: `${patterns.length} kritische Patterns erkannt. DB2 ${benchmarks.db2.diff > 0 ? '+' : ''}${benchmarks.db2.diff.toFixed(0)}pp vs. Industrie.`,
                            recommendation: patterns.length > 2 
                                ? 'Sofortige Intervention erforderlich' 
                                : 'Business Case robust - Fortf√ºhrung empfohlen',
                            actions: patterns.map(p => p.name),
                            timestamp: 'Analyse komplett'
                        });
                    }, 2000);
                    break;
                    
                case 'stress-test':
                    cfoDashboard.aiController.addAIMessage({
                        level: 'warning',
                        title: 'üî¨ Stress-Test Results',
                        text: 'Worst-Case: -30% Markt, +25% CAPEX ‚Üí NPV: +2.1M‚Ç¨, Payback: 6.2J.',
                        recommendation: 'Projekt bleibt positiv aber kritisch. Risk-Mitigation essentiell.',
                        impact: '97% √úberlebenswahrscheinlichkeit',
                        actions: ['Hedging-Strategien', 'Flexibilit√§t erh√∂hen', 'Exit-Klauseln'],
                        timestamp: 'Stress-Test'
                    });
                    break;
                    
                case 'sensitivity':
                    cfoDashboard.aiController.addAIMessage({
                        level: 'info',
                        title: 'üìä Sensitivit√§ts-Ranking',
                        text: 'Gr√∂√üte NPV-Hebel identifiziert.',
                        actions: [
                            '1. Absatzvolumen: ¬±15M‚Ç¨ NPV pro 10%',
                            '2. Preis-Premium: ¬±12M‚Ç¨ pro 10%', 
                            '3. CAPEX-Kontrolle: ¬±4M‚Ç¨ pro 10%',
                            '4. Herstellkosten: ¬±3M‚Ç¨ pro 10%'
                        ],
                        recommendation: 'Fokus auf Volume & Pricing f√ºr maximalen Impact.',
                        timestamp: 'Sensitivit√§t'
                    });
                    break;
                    
                case 'benchmark':
                    const comparison = cfoDashboard.aiController.compareToBenchmarks();
                    cfoDashboard.aiController.addAIMessage({
                        level: comparison.db2.diff > 0 && comparison.payback.diff < 0 ? 'success' : 'warning',
                        title: '‚öñÔ∏è Benchmark-Vergleich',
                        text: `DB2: ${comparison.db2.value}% vs. ${comparison.db2.benchmark}% Industrie (${comparison.db2.rating})
                               Payback: ${comparison.payback.value}J vs. ${comparison.payback.benchmark}J (${comparison.payback.rating})
                               ROI: ${comparison.roi.value.toFixed(0)}% vs. ${comparison.roi.benchmark}% Target (${comparison.roi.rating})`,
                        recommendation: 'Performance √ºberdurchschnittlich. Best Practices dokumentieren.',
                        timestamp: 'Benchmark'
                    });
                    break;
                    
                case 'monte-carlo':
                    cfoDashboard.aiController.addAIMessage({
                        level: 'info',
                        title: 'üé≤ Monte-Carlo-Simulation',
                        text: '10.000 Szenarien berechnet...',
                        timestamp: 'Simulation l√§uft'
                    });
                    
                    setTimeout(() => {
                        cfoDashboard.aiController.addAIMessage({
                            level: 'success',
                            title: 'üé≤ Simulations-Ergebnisse',
                            text: 'Wahrscheinlichkeitsverteilung (10.000 Iterationen):',
                            actions: [
                                'P90: NPV > 25M‚Ç¨ (90% Wahrscheinlichkeit)',
                                'P50: NPV = 44M‚Ç¨ (Median-Szenario)',
                                'P10: NPV > 62M‚Ç¨ (Best Case)',
                                'Break-Even: 97.3% Wahrscheinlichkeit',
                                'Negativ-NPV: 2.7% Risiko'
                            ],
                            recommendation: 'Risikoprofil akzeptabel. 2.7% Verlustrisiko durch Hedging absichern.',
                            timestamp: 'Simulation komplett'
                        });
                    }, 2500);
                    break;
                    
                case 'export':
                    cfoDashboard.aiController.addAIMessage({
                        level: 'success',
                        title: 'üìÑ Board-Pr√§sentation erstellt',
                        text: 'Executive Summary mit KI-Insights exportiert.',
                        actions: [
                            'Slide 1: Executive Summary & KI-Empfehlung',
                            'Slide 2: Financials & KPIs vs. Benchmark',
                            'Slide 3: Risk-Matrix & Mitigation (KI-generiert)',
                            'Slide 4: Sensitivit√§t & Monte-Carlo Results',
                            'Slide 5: Next Steps & Go/No-Go Empfehlung'
                        ],
                        recommendation: 'Pr√§sentation Board-ready. Download startet...',
                        timestamp: 'Export'
                    });
                    break;
            }
        }

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            initializeAI();
        });

        function initializeAI() {
            // Initial welcome message
            cfoDashboard.aiController.addAIMessage({
                level: 'success',
                title: 'üöÄ KI-Controller aktiviert',
                text: 'System bereit. Business Case WCAR geladen: NPV +44.7M‚Ç¨, Payback 3.4J, DB2 34%.',
                recommendation: 'Baseline erfasst. Verwenden Sie die Slider f√ºr What-If-Analysen.',
                timestamp: 'System-Start'
            });
            
            // Initial benchmark comparison
            setTimeout(() => {
                const comparison = cfoDashboard.aiController.compareToBenchmarks();
                cfoDashboard.aiController.addAIMessage({
                    level: 'info',
                    title: 'üìä Initiale Bewertung',
                    text: `Business Case solide. DB2-Marge ${comparison.db2.diff.toFixed(0)}pp √ºber Industrie. Payback ${Math.abs(comparison.payback.diff).toFixed(1)}J ${comparison.payback.rating} als Benchmark.`,
                    recommendation: 'Fokus auf CAPEX-Kontrolle und Marktpenetration.',
                    actions: ['Quartalweise Reviews', 'Vertriebsforecast validieren', 'Preissensitivit√§t monitoren'],
                    timestamp: 'Baseline-Analyse'
                });
            }, 1500);
            
            // Run initial pattern check
            setTimeout(() => {
                cfoDashboard.aiController.runPatternAnalysis();
            }, 3000);
        }

        function initializeCharts() {
            // Initialize all 6 charts matching Excel layout
            initUmsatzChart();
            initAbsatzChart();
            initDB2Chart();
            initProjektkostenChart();
            initDB3JahrChart();
            initDB3KumuliertChart();
        }

        function initUmsatzChart() {
            const ctx = document.getElementById('umsatz-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['2024', '2025', '2026', '2027', '2028', '2029', '2030', '2031', '2032'],
                    datasets: [{
                        label: 'Umsatz',
                        data: [0.0, 2.9, 10.8, 24.2, 42.3, 47.0, 48.8, 0.0, 0.0],
                        backgroundColor: '#9ca3af',
                        borderColor: '#6b7280',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '';
                                }
                            }
                        }
                    }
                }
            });
        }

        function initAbsatzChart() {
            const ctx = document.getElementById('absatz-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['2024', '2025', '2026', '2027', '2028', '2029', '2030', '2031', '2032'],
                    datasets: [{
                        label: 'Absatz',
                        data: [0.0, 0.2, 1.1, 2.8, 5.5, 5.6, 5.6, 0.0, 0.0],
                        backgroundColor: '#9ca3af',
                        borderColor: '#6b7280',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function initDB2Chart() {
            const ctx = document.getElementById('db2-chart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['2024', '2025', '2026', '2027', '2028', '2029', '2030', '2031', '2032'],
                    datasets: [{
                        label: 'DB2',
                        data: [0.0, 1.0, 3.7, 8.5, 15.4, 17.1, 17.8, 0.0, 0.0],
                        backgroundColor: '#9ca3af',
                        borderColor: '#6b7280',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'DB2 %',
                        data: [0, 33, 34, 35, 36, 36, 36, 0, 0],
                        type: 'line',
                        borderColor: '#6b7280',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        yAxisID: 'y1',
                        pointStyle: 'circle',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 40,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function initProjektkostenChart() {
            const ctx = document.getElementById('projektkosten-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['2024', '2025', '2026', '2027', '2028', '2029', '2030', '2031', '2032'],
                    datasets: [{
                        label: 'Projektkosten',
                        data: [1.6, 2.5, 3.2, 2.9, 2.9, 3.1, 2.5, 0.0, 0.0],
                        backgroundColor: '#9ca3af',
                        borderColor: '#6b7280',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function initDB3JahrChart() {
            const ctx = document.getElementById('db3-jahr-chart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['2024', '2025', '2026', '2027', '2028', '2029', '2030', '2031', '2032'],
                    datasets: [{
                        label: 'DB3',
                        data: [-1.6, -1.6, 0.5, 5.6, 12.4, 14.0, 15.3, 0.0, 0.0],
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value < 0 ? '#ef4444' : '#9ca3af';
                        },
                        borderColor: '#6b7280',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'DB3 %',
                        data: [-54, -5, 23, 29, 30, 31, 0, 0, 0],
                        type: 'line',
                        borderColor: '#6b7280',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        yAxisID: 'y1',
                        pointStyle: 'circle',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left'
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function initDB3KumuliertChart() {
            const ctx = document.getElementById('db3-kumuliert-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['2024', '2025', '2026', '2027', '2028', '2029', '2030', '2031', '2032'],
                    datasets: [{
                        label: 'DB3 kumuliert',
                        data: [-1.6, -3.1, -2.6, 3.0, 15.5, 29.4, 44.7, 44.7, 44.7],
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value < 0 ? '#ef4444' : '#9ca3af';
                        },
                        borderColor: '#6b7280',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
